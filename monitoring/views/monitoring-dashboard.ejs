<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Darsinurse - Dashboard Monitoring</title>
  <div style="
    position: fixed;
    top: 20px;
    right: 20px;
    background: white;
    padding: 8px 16px;
    border-radius: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    font-weight: 600;
    z-index: 9998;
  ">
    <span data-status>üü° CONNECTING...</span>
  </div>
  <link rel="icon" type="image/png" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üìä</text></svg>">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Socket.IO Client -->
  <script src="/socket.io/socket.io.js"></script>
  
  <style>
    :root {
      --primary-green: #00B14F;
      --secondary-green: #008a3d;
      --primary-blue: #0056b3;
      --primary-dark: #003d7a;
      --secondary-teal: #20c997;
      --light-bg: #f0f8f7;
      --dark-text: #1a3a3a;
      --gray-border: #e0e0e0;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: var(--dark-text);
      background: #f5f5f5;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .top-header {
      background: white;
      padding: 1rem 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-section i {
      font-size: 28px;
      color: var(--primary-green);
    }

    .logo-section h1 {
      font-size: 22px;
      font-weight: 700;
      color: var(--dark-text);
      margin: 0;
    }

    .nav-section {
      display: flex;
      align-items: center;
      gap: 20px;
      font-size: 14px;
    }

    .nav-section a {
      color: var(--primary-blue);
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s;
    }

    .nav-section a:hover {
      color: var(--primary-dark);
    }

    .logout-btn {
      color: #dc3545 !important;
    }

    .logout-btn:hover {
      color: #c82333 !important;
    }

    /* Main Container */
    .main-container {
      padding-top: 70px !important;
      flex: 1;
    }

    .page-header {
      margin-bottom: 30px;
    }

    .page-title {
      font-size: 32px;
      font-weight: 700;
      color: var(--dark-text);
      margin-bottom: 8px;
    }

    .page-subtitle {
      font-size: 16px;
      color: #666;
    }

    /* Tab Navigation */
    .tab-navigation {
      display: flex;
      gap: 20px;
      border-bottom: 2px solid var(--gray-border);
      margin-bottom: 30px;
    }

    .tab-button {
      background: none;
      border: none;
      padding: 12px 0;
      font-size: 16px;
      font-weight: 600;
      color: #666;
      cursor: pointer;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
    }

    .tab-button:hover {
      color: var(--primary-green);
    }

    .tab-button.active {
      color: var(--primary-green);
      border-bottom-color: var(--primary-green);
    }

    /* Tab Content */
    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      transition: all 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.12);
    }

    .stat-label {
      font-size: 12px;
      color: #999;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .stat-number {
      font-size: 36px;
      font-weight: 700;
      color: var(--primary-green);
      margin-bottom: 4px;
    }

    .stat-change {
      font-size: 12px;
      color: #666;
    }

    .stat-icon {
      float: right;
      font-size: 32px;
      color: rgba(0, 177, 79, 0.2);
    }

    /* Data Table */
    .data-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      overflow: hidden;
    }

    .data-header {
      background: linear-gradient(135deg, var(--primary-green), var(--secondary-green));
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .data-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
    }

    .data-body {
      padding: 20px;
      max-height: 600px;
      overflow-y: auto;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .data-table thead {
      background: #f9f9f9;
      border-bottom: 2px solid var(--gray-border);
    }

    .data-table th {
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: var(--dark-text);
    }

    .data-table td {
      padding: 12px;
      border-bottom: 1px solid var(--gray-border);
    }

    .data-table tbody tr:hover {
      background: #f9f9f9;
    }

    .badge-status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-aktif {
      background: #e6f9e6;
      color: #28a745;
    }

    .badge-selesai {
      background: #e7f3ff;
      color: var(--primary-blue);
    }

    .metabase-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      overflow: hidden;
      position: relative;
      min-height: 850px; /* ‚Üê SUDAH ADA ‚úì */
    }

    .loading-progress-bar {
      width: 200px;
      height: 4px;
      background: #e0e0e0;
      border-radius: 2px;
      overflow: hidden;
      margin-top: 10px;
    }

    .loading-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-green), var(--secondary-teal));
      width: 0%;
      animation: progress 3s ease-in-out infinite;
    }

    .loading-spinner {
      position: absolute;
      top: 60px; /* ‚Üê SUDAH BENAR ‚úì */
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 10;
      background: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 15px;
      color: var(--primary-green);
    }

    .loading-spinner i {
      font-size: 48px;
      animation: spin 2s linear infinite;
    }

    .loading-spinner span {
      font-size: 16px;
      font-weight: 600;
      color: #666;
    }
    @keyframes progress {
      0% { width: 0%; }
      50% { width: 70%; }
      100% { width: 100%; }
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .refresh-btn {
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.5);
      color: white;
      padding: 8px 15px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
      border: none;
      font-weight: 600;
    }

    .refresh-btn:hover {
      background: rgba(255,255,255,0.3);
      color: white;
    }

    .info-box {
      background: #f0f8f7;
      border-left: 4px solid var(--secondary-teal);
      padding: 15px 20px;
      margin-top: 20px;
      border-radius: 6px;
      font-size: 14px;
      color: #333;
    }

    .info-box i {
      color: var(--secondary-teal);
      margin-right: 8px;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }

    .empty-state i {
      font-size: 48px;
      margin-bottom: 15px;
      color: #ddd;
    }

    /* ============================================ */
    /* FALL DETECTION ALERT STYLES */
    /* ============================================ */
    
    .fall-alert-container {
      position: fixed;
      top: 80px;
      right: 20px;
      z-index: 9999;
      max-width: 400px;
      width: 100%;
    }

    .fall-alert {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
      border: 3px solid #ff0000;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 10px 40px rgba(255, 0, 0, 0.4);
      animation: slideInShake 0.6s ease-out;
      position: relative;
      color: white;
    }

    @keyframes slideInShake {
      0% {
        transform: translateX(400px);
        opacity: 0;
      }
      50% {
        transform: translateX(-20px);
      }
      75% {
        transform: translateX(10px);
      }
      100% {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }

    .fall-alert-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 2px solid rgba(255, 255, 255, 0.3);
    }

    .fall-alert-icon {
      font-size: 36px;
      animation: pulse 1s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.2);
        opacity: 0.8;
      }
    }

    .fall-alert-title {
      font-size: 20px;
      font-weight: 700;
      margin: 0;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .fall-alert-body {
      margin-bottom: 15px;
    }

    .fall-alert-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .fall-alert-label {
      font-weight: 600;
      opacity: 0.9;
    }

    .fall-alert-value {
      font-weight: 700;
      background: rgba(255, 255, 255, 0.2);
      padding: 2px 8px;
      border-radius: 4px;
    }

    .fall-alert-footer {
      display: flex;
      gap: 10px;
    }

    .fall-alert-btn {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
    }

    .btn-acknowledge {
      background: white;
      color: #ff6b6b;
    }

    .btn-acknowledge:hover {
      background: #f0f0f0;
      transform: translateY(-2px);
    }

    .btn-close {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.4);
    }

    .btn-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .fall-alert-timestamp {
      font-size: 11px;
      opacity: 0.8;
      text-align: center;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* Footer */
    .footer {
      background: #2c3e50;
      color: white;
      padding: 20px 0;
      text-align: center;
      margin-top: auto;
    }

    .footer p {
      margin: 0;
      font-size: 14px;
      opacity: 0.9;
    }

    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }

      .nav-section {
        flex-wrap: wrap;
        justify-content: center;
      }

      .page-title {
        font-size: 24px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .metabase-iframe {
        min-height: 500px;
      }

      .data-body {
        max-height: 400px;
      }

      .tab-navigation {
        flex-wrap: wrap;
      }

      .fall-alert-container {
        left: 10px;
        right: 10px;
        max-width: none;
      }
    }
  </style>
</head>
<body>
  <!-- Fall Alert Sound -->
  <audio id="fall-alert-sound" preload="auto">    </audio>
  

  <!-- Fall Alert Container -->
  <div class="fall-alert-container" id="fall-alert-container"></div>

  <!-- Header -->
  <header class="top-header">
    <div class="container-fluid">
      <div class="header-content">
        <div class="logo-section">
          <i class="fas fa-chart-line"></i>
          <h1>Darsinurse</h1>
        </div>

        <div class="nav-section">
          <span>
            <i class="fas fa-user-circle"></i> <%= nama_perawat %>
          </span>
          <span>|</span>
          <a href="/logout" class="logout-btn" onclick="return confirm('Yakin logout?')">
            <i class="fas fa-sign-out-alt"></i> Logout
          </a>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <div class="container-fluid py-4 main-container">
    <!-- Tab Navigation -->
    <div class="tab-navigation">
      <button class="tab-button active" data-tab="rawat-jalan">
        <i class="fas fa-hospital-user"></i> Rawat Jalan
      </button>
      <button class="tab-button" data-tab="rawat-inap">
        <i class="fas fa-bed"></i> Rawat Inap
      </button>
    </div>

    <!-- TAB 1: RAWAT JALAN (Custom Dashboard) -->
    <div id="rawat-jalan" class="tab-content active">
      <!-- Statistics Cards -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-users"></i></div>
          <div class="stat-label">Total Kunjungan Hari Ini</div>
          <div class="stat-number" id="total-visits">-</div>
          <div class="stat-change">Pasien</div>
        </div>

        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-heartbeat"></i></div>
          <div class="stat-label">Total Pengukuran</div>
          <div class="stat-number" id="total-measurements">-</div>
          <div class="stat-change">Data</div>
        </div>
      </div>

      <!-- Visits Table -->
      <div class="data-container" style="margin-bottom: 30px;">
        <div class="data-header">
          <h3><i class="fas fa-list"></i> Daftar Kunjungan Hari Ini</h3>
          <button class="refresh-btn" onclick="loadRawatJalanData()">
            <i class="fas fa-sync"></i> Refresh
          </button>
        </div>
        <div class="data-body">
          <table class="data-table">
            <thead>
              <tr>
                <th>ID Kunjungan</th>
                <th>Nama Pasien</th>
                <th>EMR</th>
                <th>Keluhan</th>
                <th>Perawat</th>
                <th>Status</th>
                <th>Pengukuran</th>
              </tr>
            </thead>
            <tbody id="visits-table-body">
              <tr>
                <td colspan="7" class="text-center text-muted py-4">
                  <i class="fas fa-spinner fa-spin"></i> Memuat data...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Measurements Table -->
      <div class="data-container">
        <div class="data-header">
          <h3><i class="fas fa-heartbeat"></i> Data Pengukuran Hari Ini <% if (role !== 'admin') { %><small style="font-size: 14px; opacity: 0.9;">(Data pasien Anda)</small><% } %></h3>
          <button class="refresh-btn" onclick="loadMeasurementsData()">
            <i class="fas fa-sync"></i> Refresh
          </button>
        </div>
        <div class="data-body">
          <table class="data-table">
            <thead>
              <tr>
                <th>Waktu</th>
                <th>Pasien</th>
                <th>Jenis Pengukuran</th>
                <th>Nilai</th>
                <% if (role === 'admin') { %>
                <th>Perawat</th>
                <% } %>
              </tr>
            </thead>
            <tbody id="measurements-table-body">
              <tr>
                <td colspan="<%= role === 'admin' ? '5' : '4' %>" class="text-center text-muted py-4">
                  <i class="fas fa-spinner fa-spin"></i> Memuat data...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="info-box">
        <i class="fas fa-info-circle"></i>
        <strong>Informasi:</strong> Dashboard ini menampilkan data real-time kunjungan rawat jalan dan pengukuran vital sign dari <% if (role === 'admin') { %>semua pasien<% } else { %>pasien yang Anda tangani<% } %> yang berkunjung hari ini.
      </div>
    </div>

    <!-- TAB 2: RAWAT INAP (Metabase Embed) -->
    <div id="rawat-inap" class="tab-content">
      <div class="metabase-container">
        <div class="data-header">
          <h3><i class="fas fa-bed"></i> Dashboard Rawat Inap - Metabase</h3>
          <button class="refresh-btn" onclick="loadMetabaseDashboard()">
            <i class="fas fa-sync"></i> Refresh
          </button>
        </div>
        <div id="metabase-loading" class="loading-spinner" style="display:flex;">
          <i class="fas fa-spinner"></i>
          <span>Memuat dashboard Metabase...</span>
          
          <!-- Progress Bar -->
          <div class="loading-progress-bar">
            <div class="loading-progress-fill"></div>
          </div>
          
          <small style="color: #999; font-size: 12px; margin-top: 10px;">
            Harap tunggu beberapa saat
          </small>
        </div>
        <iframe id="metabase-iframe" 
          class="metabase-iframe"
          style="display:none; width: 100%; height: 800px; border: none;"
          title="Darsinurse - Dashboard Rawat Inap">
        </iframe>
      </div>
      <div class="info-box">
        <i class="fas fa-info-circle"></i>
        <strong>Informasi:</strong> Dashboard ini menampilkan data real-time pasien rawat inap termasuk monitoring vital sign kontinyu, bed management, dan status medical alerts.
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <p>&copy; 2025 Darsinurse Monitoring - Medical IoT Platform. All rights reserved.</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // ============================================
    // SOCKET.IO CLIENT - FALL DETECTION
    // ============================================

    // Initialize Socket.IO connection
  // Initialize Socket.IO connection
    const socket = io({
      reconnection: true,
      reconnectionDelay: 1000,
      reconnectionAttempts: 5
    });

    // Connection handlers
    socket.on('connect', () => {
      console.log('‚úì Socket.IO connected:', socket.id);
      socket.emit('join-monitoring', { 
        perawat: '<%= nama_perawat %>',
        timestamp: new Date().toISOString() 
      });
    });

    socket.on('disconnect', () => {
      console.warn('‚ö†Ô∏è Socket.IO disconnected');
    });

    socket.on('connect_error', (error) => {
      console.error('‚ùå Socket connection error:', error);
      setTimeout(() => socket.connect(), 3000);
    });
    socket.on('rawat-jalan-connected', (data) => {
      console.log('‚úÖ Fall Detection System ONLINE');
      addLog('Fall detection system is now active', 'success');
      
      // Optional: tampilkan badge green
      const statusBadge = document.querySelector('[data-status]');
      if (statusBadge) {
        statusBadge.innerHTML = 'üü¢ ONLINE';
        statusBadge.style.color = '#28a745';
      }
    });

    socket.on('rawat-jalan-disconnected', (data) => {
      console.warn('‚ö†Ô∏è Fall Detection System OFFLINE');
      addLog('‚ö†Ô∏è Fall detection system is OFFLINE!', 'error');
      
      // Tampilkan badge red
      const statusBadge = document.querySelector('[data-status]');
      if (statusBadge) {
        statusBadge.innerHTML = 'üî¥ OFFLINE';
        statusBadge.style.color = '#dc3545';
      }
    });
    function addLog(message, type = 'info') {
      // Function kosong (untuk monitoring dashboard, tidak ada activity log)
      // Jadi cukup console.log saja
      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    function showStatus(type, message, alertType = 'info') {
      // Tidak ada status div di monitoring dashboard
      // Jadi cukup log saja
      console.log(`[STATUS] ${message}`);
    }
    const displayedAlerts = new Set();
    let fallDetectionInterval = null;

    console.log('‚úì Auto-fetch fall detection initialized');
    // ‚úÖ PRIMARY LISTENER - Listen event 'fall-alert'
    socket.on('fall-alert', (alert) => {
      console.log('üö®üö®üö® FALL ALERT DITERIMA DI DASHBOARD!');
      console.log('   Data:', JSON.stringify(alert, null, 2));
      
      // Validasi data
      if (!alert || !alert.nama_pasien) {
        console.error('‚ùå DATA TIDAK VALID:', alert);
        return;
      }
      
      // 1Ô∏è‚É£ SUARA
      playAlertSound();
      displayedAlerts.add(`${alert.id}`); // Mark sebagai seen
      setInterval(async () => {
        const res = await fetch('/api/fall-detection/latest');
        const data = await res.json();
        
        data.falls.forEach(fall => {
          if (!displayedAlerts.has(fall.id)) {
            // Belum ditampilkan, tampilkan sekarang
            showFallAlert(fall);
            displayedAlerts.add(fall.id);
          }
        });
      }, 10000); // Check every 10 seconds
      // 2Ô∏è‚É£ VISUAL POPUP
      showFallAlert(alert);
      
      // 3Ô∏è‚É£ DESKTOP NOTIFICATION
        if (Notification.permission === 'granted') {
          const notification = new Notification('üö® FALL ALERT!', {
            body: `${alert.nama_pasien} - Room ${alert.room_id}\nEMR: ${alert.emr_no}`,
            icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="80" fill="red">‚ö†Ô∏è</text></svg>',
            tag: `fall-${alert.id}`,
            requireInteraction: true,
            vibrate: [200, 100, 200],
            badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="red"/></svg>'
          });
          
          notification.onclick = () => {
            window.focus();
            notification.close();
          };
        }
      })

    
    // 4Ô∏è‚É£ BADGE API (Update unread count)
    if ('setAppBadge' in navigator) {
      navigator.setAppBadge(1);
    }
      
      // 5Ô∏è‚É£ LOG
    addLog(`üö® FALL DETECTED: ${alert.nama_pasien} (EMR: ${alert.emr_no})`, 'error');
      
    console.log('‚úì Alert ditampilkan di dashboard');

    // ============================================
    // ALERT FUNCTIONS
    // ============================================
    function showFallAlert(alert) {
      const container = document.getElementById('fall-alert-container');
      if (!container) return;
      
      const alertDiv = document.createElement('div');
      alertDiv.className = 'fall-alert';
      alertDiv.id = `fall-alert-${alert.id}`;
      
      const waktu = new Date(alert.waktu);
      const waktuStr = waktu.toLocaleTimeString('id-ID', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      
      alertDiv.innerHTML = `
        <div class="fall-alert-header">
          <div class="fall-alert-icon">‚ö†Ô∏è</div>
          <h3 class="fall-alert-title">FALL DETECTED!</h3>
        </div>
        
        <div class="fall-alert-body">
          <div class="fall-alert-info">
            <span class="fall-alert-label">üë§ Pasien:</span>
            <span class="fall-alert-value">${alert.nama_pasien}</span>
          </div>
          
          <div class="fall-alert-info">
            <span class="fall-alert-label">üè• Ruangan:</span>
            <span class="fall-alert-value">${alert.room_id}</span>
          </div>
          
          <div class="fall-alert-info">
            <span class="fall-alert-label">üìã EMR:</span>
            <span class="fall-alert-value">${alert.emr_no}</span>
          </div>
          
          <div class="fall-alert-info">
            <span class="fall-alert-label">üíì Heart Rate:</span>
            <span class="fall-alert-value">${alert.heart_rate || 'N/A'} bpm</span>
          </div>
          
          <div class="fall-alert-info">
            <span class="fall-alert-label">ü©∫ Blood Pressure:</span>
            <span class="fall-alert-value">${alert.blood_pressure || 'N/A'} mmHg</span>
          </div>
          
          <div class="fall-alert-info">
            <span class="fall-alert-label">üïê Waktu:</span>
            <span class="fall-alert-value">${waktuStr}</span>
          </div>
        </div>
        
        <div class="fall-alert-footer">
          <button class="fall-alert-btn btn-acknowledge" onclick="acknowledgeFallAlert(${alert.id})">
            ‚úì Acknowledge
          </button>
          <button class="fall-alert-btn btn-close" onclick="closeFallAlert(${alert.id})">
            ‚úï Close
          </button>
        </div>
        
        <div class="fall-alert-timestamp">
          Alert received at ${new Date().toLocaleTimeString('id-ID')}
        </div>
      `;
      
      container.insertBefore(alertDiv, container.firstChild);
      
      // Auto-close after 2 minutes
      setTimeout(() => {
        closeFallAlert(alert.id);
      }, 120000);
    }

    // ‚úÖ SIMPLIFY: Cukup close alert, tidak perlu fetch
    function acknowledgeFallAlert(alertId) {
      console.log('‚úì Acknowledging alert:', alertId);
      stopAlertSound();
      
      if (currentAlertAudio) {
        currentAlertAudio.pause();
        currentAlertAudio.currentTime = 0;
        currentAlertAudio.onended = null;
      }
      
      closeFallAlert(alertId);
    }

    function closeFallAlert(alertId) {
        // STOP AUDIO
        stopAlertSound();
        if (currentAlertAudio) {
            currentAlertAudio.pause();
            currentAlertAudio.currentTime = 0;
            currentAlertAudio.onended = null;
        }
        
        const alertDiv = document.getElementById(`fall-alert-${alertId}`);
        if (alertDiv) {
            alertDiv.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => {
            alertDiv.remove();
            }, 300);
        }
    }

    // ============================================
    // TAB NAVIGATION
    // ============================================
    document.querySelectorAll('.tab-button').forEach(button => {
      button.addEventListener('click', function() {
        const tabName = this.dataset.tab;
        
        // Deactivate all tabs
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        
        // Activate selected tab
        this.classList.add('active');
        document.getElementById(tabName).classList.add('active');
        
        // Load data when tab changes
        if (tabName === 'rawat-jalan') {
          loadRawatJalanData();
        } else if (tabName === 'rawat-inap') {
          loadMetabaseDashboard();
        }
      });
    });

    // ============================================
    // RAWAT JALAN DATA LOADING
    // ============================================
    async function loadRawatJalanData() {
      try {
        console.log('üîÑ Loading Rawat Jalan data...');
        
        // Load Statistics
        const statsResponse = await fetch('/api/statistics/today');
        const statsData = await statsResponse.json();
        
        console.log('üìä Stats data:', statsData);
        
        if (statsData.success) {
          const totalVisitsEl = document.getElementById('total-visits');
          const totalMeasurementsEl = document.getElementById('total-measurements');
          
          if (totalVisitsEl) {
            totalVisitsEl.textContent = statsData.stats.totalVisits || 0;
            console.log('‚úì Total visits updated:', statsData.stats.totalVisits);
          }
          
          if (totalMeasurementsEl) {
            totalMeasurementsEl.textContent = statsData.stats.totalMeasurements || 0;
            console.log('‚úì Total measurements updated:', statsData.stats.totalMeasurements);
          }
        }

        // Load Visits
        await loadVisitsData();

        // Load Measurements
        await loadMeasurementsData();

        console.log('‚úì Rawat Jalan data loaded successfully');
      } catch (err) {
        console.error('‚ùå Error loading data:', err);
        alert('Gagal memuat data: ' + err.message);
      }
    }

    // ============================================
    // LOAD VISITS TABLE
    // ============================================
    async function loadVisitsData() {
      try {
        console.log('üîÑ Loading visits...');
        
        const visitsResponse = await fetch('/api/visits/today');
        const visitsData = await visitsResponse.json();
        
        console.log('üìã Visits data:', visitsData);
        
        if (visitsData.success) {
          const tbody = document.getElementById('visits-table-body');
          
          if (!tbody) {
            console.error('‚ùå Element #visits-table-body not found');
            return;
          }
          
          if (visitsData.visits.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">Tidak ada data kunjungan hari ini</td></tr>';
            console.log('‚ÑπÔ∏è No visits today');
          } else {
            tbody.innerHTML = visitsData.visits.map(visit => `
              <tr>
                <td><strong>${visit.id_kunjungan}</strong></td>
                <td>${visit.nama_pasien}</td>
                <td>${visit.emr_no}</td>
                <td>${visit.keluhan || '-'}</td>
                <td>${visit.nama_perawat}</td>
                <td><span class="badge-status badge-${visit.status}">${visit.status === 'aktif' ? 'Aktif' : 'Selesai'}</span></td>
                <td><span class="badge bg-info">${visit.total_measurements} data</span></td>
              </tr>
            `).join('');
            console.log('‚úì Visits table updated with', visitsData.visits.length, 'records');
          }
        }
      } catch (err) {
        console.error('‚ùå Error loading visits:', err);
        const tbody = document.getElementById('visits-table-body');
        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger py-4">Error: ' + err.message + '</td></tr>';
        }
      }
    }

    // ============================================
    // LOAD MEASUREMENTS TABLE
    // ============================================
    async function loadMeasurementsData() {
      try {
        console.log('üîÑ Loading measurements...');
        
        const measurementsResponse = await fetch('/api/measurements/today');
        const measurementsData = await measurementsResponse.json();
        
        console.log('üíâ Measurements data:', measurementsData);
        
        if (measurementsData.success) {
          const tbody = document.getElementById('measurements-table-body');
          
          if (!tbody) {
            console.error('‚ùå Element #measurements-table-body not found');
            return;
          }
          
          const isAdmin = '<%= role %>' === 'admin';
          const colspan = isAdmin ? '5' : '4';
          
          if (measurementsData.measurements.length === 0) {
            tbody.innerHTML = `<tr><td colspan="${colspan}" class="text-center text-muted py-4">Tidak ada pengukuran hari ini</td></tr>`;
            console.log('‚ÑπÔ∏è No measurements today');
          } else {
            tbody.innerHTML = measurementsData.measurements.map(m => {
              const perawatColumn = isAdmin ? `<td>${m.nama_perawat}</td>` : '';
              return `
                <tr>
                  <td>${new Date(m.timestamp).toLocaleTimeString('id-ID')}</td>
                  <td>${m.nama_pasien}</td>
                  <td><span class="badge bg-success">${m.tipe_device}</span></td>
                  <td><strong>${m.data}</strong></td>
                  ${perawatColumn}
                </tr>
              `;
            }).join('');
            console.log('‚úì Measurements table updated with', measurementsData.measurements.length, 'records');
          }
        }
      } catch (err) {
        console.error('‚ùå Error loading measurements:', err);
        const tbody = document.getElementById('measurements-table-body');
        if (tbody) {
          const colspan = '<%= role %>' === 'admin' ? '5' : '4';
          tbody.innerHTML = `<tr><td colspan="${colspan}" class="text-center text-danger py-4">Error: ${err.message}</td></tr>`;
        }
      }
    }

    // ============================================
    // METABASE DASHBOARD LOADING
    // ============================================
    async function loadMetabaseDashboard() {
      const loadingDiv = document.getElementById('metabase-loading');
      const iframe = document.getElementById('metabase-iframe');
      
      if (!loadingDiv || !iframe) {
        console.error('‚ùå Elements not found');
        return;
      }
      
      // Show loading with smooth fade
      loadingDiv.style.display = 'flex';
      loadingDiv.style.opacity = '1';
      loadingDiv.style.transition = 'opacity 0.3s ease';
      iframe.style.display = 'none';
      
      try {
        console.log('üîÑ Loading Metabase...');
        
        const response = await fetch('/api/metabase/rawat-inap-token');
        const data = await response.json();
        
        console.log('üìä API Response:', data);
        
        if (data.success && data.embedUrl) {
          iframe.src = data.embedUrl;
          
          iframe.onload = function() {
            console.log('‚úì Iframe loaded');
            
            // Smooth fade out loading
            loadingDiv.style.opacity = '0';
            
            setTimeout(() => {
              loadingDiv.style.display = 'none';
              iframe.style.display = 'block';
              iframe.style.opacity = '0';
              iframe.style.transition = 'opacity 0.3s ease';
              
              // Fade in iframe
              requestAnimationFrame(() => {
                iframe.style.opacity = '1';
              });
            }, 300);
          };
          
          iframe.onerror = function() {
            console.error('‚ùå Iframe failed to load');
            loadingDiv.innerHTML = `
              <div style="text-align: center; color: #dc3545;">
                <i class="fas fa-exclamation-triangle" style="font-size: 48px;"></i>
                <p style="margin-top: 15px;"><strong>Gagal memuat dashboard</strong></p>
                <button onclick="loadMetabaseDashboard()" class="btn btn-sm btn-primary mt-3">
                  <i class="fas fa-sync"></i> Coba Lagi
                </button>
              </div>
            `;
          };
          
          // Fallback timeout (5 detik)
          setTimeout(() => {
            if (iframe.style.display === 'none') {
              console.log('‚è±Ô∏è Timeout: showing iframe anyway');
              loadingDiv.style.opacity = '0';
              setTimeout(() => {
                loadingDiv.style.display = 'none';
                iframe.style.display = 'block';
                iframe.style.opacity = '1';
              }, 300);
            }
          }, 5000);
          
        } else {
          throw new Error(data.error || 'Invalid response');
        }
      } catch (err) {
        console.error('‚ùå Error:', err);
        loadingDiv.innerHTML = `
          <div style="text-align: center; color: #dc3545; padding: 40px;">
            <i class="fas fa-exclamation-circle" style="font-size: 48px;"></i>
            <p style="margin-top: 15px;"><strong>Gagal memuat dashboard</strong></p>
            <p style="color: #666;">${err.message}</p>
            <button onclick="loadMetabaseDashboard()" class="btn btn-sm btn-primary mt-3">
              <i class="fas fa-sync"></i> Coba Lagi
            </button>
          </div>
        `;
      }
    }
    
    // ============================================
    // GLOBAL STATE
    // ============================================
    let audioUnlocked = false;
    let currentAlertAudio = null;

    // ============================================
    // UNLOCK AUDIO ON FIRST INTERACTION
    // ============================================
    function unlockAudio() {
    if (audioUnlocked) return;

    const audio = document.getElementById('fall-alert-sound');
    if (audio) {
        audio.play()
        .then(() => {
            audio.pause();
            audio.currentTime = 0;
            audioUnlocked = true;
            console.log('‚úì Alert sounds enabled');
        })
        .catch(() => {
            // Ignore error on unlock attempt
        });
    }
    }

    // Listen for interactions
    ['click', 'keydown', 'touchstart', 'mousedown'].forEach(event => {
    document.addEventListener(event, unlockAudio, { once: true });
    });

    // ============================================
    // PLAY ALERT SOUND
    // ============================================
    function playAlertSound() {
    const audio = document.getElementById('fall-alert-sound');
    if (!audio) return;

    currentAlertAudio = audio;
    audio.loop = true;
        audio.play()
        .then(() => {
        console.log('üîä Alert sound looping');
        })
        .catch(() => {
        console.warn('‚ö†Ô∏è Click anywhere to enable sound');

        const retryPlay = () => {
            audio.play().then(() => {
            console.log('‚úì Alert sound now looping');
            });
            document.removeEventListener('click', retryPlay);
        };

        document.addEventListener('click', retryPlay, { once: true });
        });
    }

    // ============================================
    // STOP ALERT SOUND
    // ============================================
    function stopAlertSound() {
        if (currentAlertAudio) {
            currentAlertAudio.pause();
            currentAlertAudio.currentTime = 0;
            currentAlertAudio.loop = false;
        }
    }

    // ============================================
    // INITIALIZATION (GABUNGAN)
    // ============================================
    document.addEventListener('DOMContentLoaded', function() {
      // Request notification permission
      if ("Notification" in window && Notification.permission === "default") {
        Notification.requestPermission().then(permission => {
          console.log('üì¢ Notification permission:', permission);
        });
      }
      console.log('‚úì Page loaded, initializing...');
        
        
        // Audio unlock banner
        setTimeout(() => {
            if (!audioUnlocked) {
            console.warn('‚ö†Ô∏è Click anywhere to enable alert sounds');
            const banner = document.createElement('div');
            banner.style.cssText = `
              position: fixed;
              top: 70px;
              left: 50%;
              transform: translateX(-50%);
              background: #ff9800;
              color: white;
              padding: 10px 20px;
              border-radius: 6px;
              z-index: 9998;
              box-shadow: 0 4px 12px rgba(0,0,0,0.3);
              font-size: 14px;
              font-weight: 600;
            `;
            banner.innerHTML = 'üîä Klik di mana saja untuk mengaktifkan suara alert';
            banner.onclick = () => {
              unlockAudio();
              banner.remove();
            };
            document.body.appendChild(banner);
            
            setTimeout(() => banner.remove(), 10000);
            }
        }, 3000);

        // Validate elements
        const requiredElements = [
            'total-visits',
            'total-measurements',
            'visits-table-body',
            'measurements-table-body'
        ];
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('/sw.js')
            .then(reg => console.log('‚úì Service Worker registered'))
            .catch(err => console.error('‚ùå SW registration failed'));
        }
        const allElementsExist = requiredElements.every(id => {
            const exists = document.getElementById(id) !== null;
            if (!exists) {
            console.error(`‚ùå Required element #${id} not found`);
            }
            return exists;
        });
        
        if (allElementsExist) {
            console.log('‚úì All required elements found, loading data...');
            loadRawatJalanData();
        } else {
            console.error('‚ùå Some required elements are missing, retrying...');
            setTimeout(() => {
            loadRawatJalanData();
            }, 500);
        }
    });

    console.log('‚úì Fall detection client initialized');
    if ('setAppBadge' in navigator) {
    // Update badge saat ada fall alert
    navigator.setAppBadge(1);

    // Clear badge saat alert di-acknowledge
    navigator.clearAppBadge();
    }
  </script>
</body>
</html>