  <!DOCTYPE html>
  <html lang="id">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Darsinurse - Dashboard Monitoring</title>
    <link rel="icon" type="image/png" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üìä</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Socket.IO Client -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <style>
      :root {
        --primary-green: #00B14F;
        --secondary-green: #008a3d;
        --primary-blue: #0056b3;
        --primary-dark: #003d7a;
        --secondary-teal: #20c997;
        --light-bg: #f0f8f7;
        --dark-text: #1a3a3a;
        --gray-border: #e0e0e0;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html, body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color: var(--dark-text);
        background: #f5f5f5;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      /* Header */
      .top-header {
        background: white;
        padding: 1rem 0;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
      }

      .header-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .logo-section {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .logo-section i {
        font-size: 28px;
        color: var(--primary-green);
      }

      .logo-section h1 {
        font-size: 22px;
        font-weight: 700;
        color: var(--dark-text);
        margin: 0;
      }

      .nav-section {
        display: flex;
        align-items: center;
        gap: 20px;
        font-size: 14px;
      }

      .nav-section a {
        color: var(--primary-blue);
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s;
      }

      .nav-section a:hover {
        color: var(--primary-dark);
      }

      .logout-btn {
        color: #dc3545 !important;
      }

      .logout-btn:hover {
        color: #c82333 !important;
      }

      /* Main Container */
      .main-container {
        padding-top: 70px !important;
        flex: 1;
      }

      .page-header {
        margin-bottom: 30px;
      }

      .page-title {
        font-size: 32px;
        font-weight: 700;
        color: var(--dark-text);
        margin-bottom: 8px;
      }

      .page-subtitle {
        font-size: 16px;
        color: #666;
      }

      /* Tab Navigation */
      .tab-navigation {
        display: flex;
        gap: 20px;
        border-bottom: 2px solid var(--gray-border);
        margin-bottom: 30px;
      }

      .tab-button {
        background: none;
        border: none;
        padding: 12px 0;
        font-size: 16px;
        font-weight: 600;
        color: #666;
        cursor: pointer;
        transition: all 0.3s;
        border-bottom: 3px solid transparent;
        margin-bottom: -2px;
      }

      .tab-button:hover {
        color: var(--primary-green);
      }

      .tab-button.active {
        color: var(--primary-green);
        border-bottom-color: var(--primary-green);
      }

      /* Tab Content */
      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      /* Stats Cards */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        transition: all 0.3s;
      }

      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.12);
      }

      .stat-label {
        font-size: 12px;
        color: #999;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
        font-weight: 600;
      }

      .stat-number {
        font-size: 36px;
        font-weight: 700;
        color: var(--primary-green);
        margin-bottom: 4px;
      }

      .stat-change {
        font-size: 12px;
        color: #666;
      }

      .stat-icon {
        float: right;
        font-size: 32px;
        color: rgba(0, 177, 79, 0.2);
      }

      /* Data Table */
      .data-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        overflow: hidden;
      }

      .data-header {
        background: linear-gradient(135deg, var(--primary-green), var(--secondary-green));
        color: white;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .data-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 700;
      }

      .data-body {
        padding: 20px;
        max-height: 600px;
        overflow-y: auto;
      }

      .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }

      .data-table thead {
        background: #f9f9f9;
        border-bottom: 2px solid var(--gray-border);
      }

      .data-table th {
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: var(--dark-text);
      }

      .data-table td {
        padding: 12px;
        border-bottom: 1px solid var(--gray-border);
      }

      .data-table tbody tr:hover {
        background: #f9f9f9;
      }

      .badge-status {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
      }

      .badge-aktif {
        background: #e6f9e6;
        color: #28a745;
      }

      .badge-selesai {
        background: #e7f3ff;
        color: var(--primary-blue);
      }

      .metabase-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        overflow: hidden;
        position: relative;
        min-height: 850px; /* ‚Üê SUDAH ADA ‚úì */
      }

      .loading-progress-bar {
        width: 200px;
        height: 4px;
        background: #e0e0e0;
        border-radius: 2px;
        overflow: hidden;
        margin-top: 10px;
      }

      .loading-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary-green), var(--secondary-teal));
        width: 0%;
        animation: progress 3s ease-in-out infinite;
      }

      .loading-spinner {
        position: absolute;
        top: 60px; /* ‚Üê SUDAH BENAR ‚úì */
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 10;
        background: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 15px;
        color: var(--primary-green);
      }

      .loading-spinner i {
        font-size: 48px;
        animation: spin 2s linear infinite;
      }

      .loading-spinner span {
        font-size: 16px;
        font-weight: 600;
        color: #666;
      }
      @keyframes progress {
        0% { width: 0%; }
        50% { width: 70%; }
        100% { width: 100%; }
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      .refresh-btn {
        background: rgba(255,255,255,0.2);
        border: 1px solid rgba(255,255,255,0.5);
        color: white;
        padding: 8px 15px;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s;
        border: none;
        font-weight: 600;
      }

      .refresh-btn:hover {
        background: rgba(255,255,255,0.3);
        color: white;
      }

      .info-box {
        background: #f0f8f7;
        border-left: 4px solid var(--secondary-teal);
        padding: 15px 20px;
        margin-top: 20px;
        border-radius: 6px;
        font-size: 14px;
        color: #333;
      }

      .info-box i {
        color: var(--secondary-teal);
        margin-right: 8px;
      }

      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #999;
      }

      .empty-state i {
        font-size: 48px;
        margin-bottom: 15px;
        color: #ddd;
      }

      /* ============================================ */
      /* FALL DETECTION ALERT STYLES */
      /* ============================================ */
      
      .fall-alert-container {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 9999;
        max-width: 400px;
        width: 100%;
      }

      .fall-alert {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        border: 3px solid #ff0000;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        box-shadow: 0 10px 40px rgba(255, 0, 0, 0.4);
        animation: slideInShake 0.6s ease-out;
        position: relative;
        color: white;
      }

      @keyframes slideInShake {
        0% {
          transform: translateX(400px);
          opacity: 0;
        }
        50% {
          transform: translateX(-20px);
        }
        75% {
          transform: translateX(10px);
        }
        100% {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(400px);
          opacity: 0;
        }
      }

      .fall-alert-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 2px solid rgba(255, 255, 255, 0.3);
      }

      .fall-alert-icon {
        font-size: 36px;
        animation: pulse 1s ease-in-out infinite;
      }

      @keyframes pulse {
        0%, 100% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.2);
          opacity: 0.8;
        }
      }

      .fall-alert-title {
        font-size: 20px;
        font-weight: 700;
        margin: 0;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .fall-alert-body {
        margin-bottom: 15px;
      }

      .fall-alert-info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 14px;
      }

      .fall-alert-label {
        font-weight: 600;
        opacity: 0.9;
      }

      .fall-alert-value {
        font-weight: 700;
        background: rgba(255, 255, 255, 0.2);
        padding: 2px 8px;
        border-radius: 4px;
      }

      .fall-alert-footer {
        display: flex;
        gap: 10px;
      }

      .fall-alert-btn {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 14px;
      }

      .btn-acknowledge {
        background: white;
        color: #ff6b6b;
      }

      .btn-acknowledge:hover {
        background: #f0f0f0;
        transform: translateY(-2px);
      }

      .btn-close {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.4);
      }

      .btn-close:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .fall-alert-timestamp {
        font-size: 11px;
        opacity: 0.8;
        text-align: center;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid rgba(255, 255, 255, 0.2);
      }

      /* Footer */
      .footer {
        background: #2c3e50;
        color: white;
        padding: 20px 0;
        text-align: center;
        margin-top: auto;
      }

      .footer p {
        margin: 0;
        font-size: 14px;
        opacity: 0.9;
      }

      @media (max-width: 768px) {
        .header-content {
          flex-direction: column;
          gap: 15px;
          text-align: center;
        }

        .nav-section {
          flex-wrap: wrap;
          justify-content: center;
        }

        .page-title {
          font-size: 24px;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }

        .metabase-iframe {
          min-height: 500px;
        }

        .data-body {
          max-height: 400px;
        }

        .tab-navigation {
          flex-wrap: wrap;
        }

        .fall-alert-container {
          left: 10px;
          right: 10px;
          max-width: none;
        }
      }
      
      @keyframes slideDown {
        from {
          transform: translate(-50%, -100%);
          opacity: 0;
        }
        to {
          transform: translate(-50%, 0);
          opacity: 1;
        }
      }

      @keyframes slideUp {
        from {
          transform: translate(-50%, 0);
          opacity: 1;
        }
        to {
          transform: translate(-50%, -100%);
          opacity: 0;
        }
      }
    </style>
  </head>
  <body>
    <!-- Fall Alert Sound -->
    <audio id="fall-alert-sound" preload="auto">   
        <source src="data:audio/wav;base64,//vQxAAAKyX1FlWsAA5EQeeXObAAAACUJBbAswmojOYkmZUmND">
      </audio>
    

    <!-- Fall Alert Container -->
    <div class="fall-alert-container" id="fall-alert-container"></div>

    <!-- Header -->
    <header class="top-header">
      <div class="container-fluid">
        <div class="header-content">
          <div class="logo-section">
            <i class="fas fa-chart-line"></i>
            <h1>Darsinurse</h1>
          </div>

          <div class="nav-section">
            <span>
              <i class="fas fa-user-circle"></i> <%= nama_perawat %>
            </span>
            <span>|</span>
            <a href="/logout" class="logout-btn" onclick="return confirm('Yakin logout?')">
              <i class="fas fa-sign-out-alt"></i> Logout
            </a>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <div class="container-fluid py-4 main-container">
      <!-- Tab Navigation -->
      <div class="tab-navigation">
        <button class="tab-button active" data-tab="rawat-jalan">
          <i class="fas fa-hospital-user"></i> Rawat Jalan
        </button>
        <button class="tab-button" data-tab="rawat-inap">
          <i class="fas fa-bed"></i> Rawat Inap
        </button>
      </div>

      <!-- TAB 1: RAWAT JALAN (Custom Dashboard) -->
      <div id="rawat-jalan" class="tab-content active">
        <!-- Statistics Cards -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-users"></i></div>
            <div class="stat-label">Total Kunjungan Hari Ini</div>
            <div class="stat-number" id="total-visits">-</div>
            <div class="stat-change">Pasien</div>
          </div>

          <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-heartbeat"></i></div>
            <div class="stat-label">Total Pengukuran</div>
            <div class="stat-number" id="total-measurements">-</div>
            <div class="stat-change">Data</div>
          </div>
        </div>

        <!-- Visits Table -->
        <div class="data-container" style="margin-bottom: 30px;">
          <div class="data-header">
            <h3><i class="fas fa-list"></i> Daftar Kunjungan Hari Ini</h3>
            <button class="refresh-btn" onclick="loadRawatJalanData()">
              <i class="fas fa-sync"></i> Refresh
            </button>
          </div>
          <div class="data-body">
            <table class="data-table">
              <thead>
                <tr>
                  <th>ID Kunjungan</th>
                  <th>Nama Pasien</th>
                  <th>EMR</th>
                  <th>Keluhan</th>
                  <th>Perawat</th>
                  <th>Status</th>
                  <th>Pengukuran</th>
                </tr>
              </thead>
              <tbody id="visits-table-body">
                <tr>
                  <td colspan="7" class="text-center text-muted py-4">
                    <i class="fas fa-spinner fa-spin"></i> Memuat data...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Measurements Table -->
        <div class="data-container">
          <div class="data-header">
            <h3><i class="fas fa-heartbeat"></i> Data Pengukuran Hari Ini <% if (role !== 'admin') { %><small style="font-size: 14px; opacity: 0.9;">(Data pasien Anda)</small><% } %></h3>
            <button class="refresh-btn" onclick="loadMeasurementsData()">
              <i class="fas fa-sync"></i> Refresh
            </button>
          </div>
          <div class="data-body">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Waktu</th>
                  <th>Pasien</th>
                  <th>Jenis Pengukuran</th>
                  <th>Nilai</th>
                  <% if (role === 'admin') { %>
                  <th>Perawat</th>
                  <% } %>
                </tr>
              </thead>
              <tbody id="measurements-table-body">
                <tr>
                  <td colspan="<%= role === 'admin' ? '5' : '4' %>" class="text-center text-muted py-4">
                    <i class="fas fa-spinner fa-spin"></i> Memuat data...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="info-box">
          <i class="fas fa-info-circle"></i>
          <strong>Informasi:</strong> Dashboard ini menampilkan data real-time kunjungan rawat jalan dan pengukuran vital sign dari <% if (role === 'admin') { %>semua pasien<% } else { %>pasien yang Anda tangani<% } %> yang berkunjung hari ini.
        </div>
      </div>

      <!-- TAB 2: RAWAT INAP (Metabase Embed) -->
      <div id="rawat-inap" class="tab-content">
        <div class="metabase-container">
          <div class="data-header">
            <h3><i class="fas fa-bed"></i> Dashboard Rawat Inap - Metabase</h3>
            <button class="refresh-btn" onclick="loadMetabaseDashboard()">
              <i class="fas fa-sync"></i> Refresh
            </button>
          </div>
          <div id="metabase-loading" class="loading-spinner" style="display:flex;">
            <i class="fas fa-spinner"></i>
            <span>Memuat dashboard Metabase...</span>
            
            <!-- Progress Bar -->
            <div class="loading-progress-bar">
              <div class="loading-progress-fill"></div>
            </div>
            
            <small style="color: #999; font-size: 12px; margin-top: 10px;">
              Harap tunggu beberapa saat
            </small>
          </div>
          <iframe id="metabase-iframe" 
            class="metabase-iframe"
            style="display:none; width: 100%; height: 800px; border: none;"
            title="Darsinurse - Dashboard Rawat Inap">
          </iframe>
        </div>
        <div class="info-box">
          <i class="fas fa-info-circle"></i>
          <strong>Informasi:</strong> Dashboard ini menampilkan data real-time pasien rawat inap termasuk monitoring vital sign kontinyu, bed management, dan status medical alerts.
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
      <p>&copy; 2025 Darsinurse Monitoring - Medical IoT Platform. All rights reserved.</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
      /* ============================================================
        CORRECTED CLIENT-SIDE SCRIPT FOR MONITORING.EJS
        Ganti semua kode JavaScript di dalam <script> tag
        ============================================================ */

      // ============================================
      // GLOBAL STATE
      // ============================================
      let audioUnlocked = false;
      let currentAlertAudio = null;
      const displayedAlerts = new Map(); // Track with timestamp
      let fallCheckInterval = null;
      let activeAlertsCount = 0;
      let lastPollTime = Date.now();
      let audioContext = null;
      let alertAudioBuffer = null;
      let audioSource = null;
      let isAudioPlaying = false; // ‚úÖ NEW



      // ============================================
      // AUDIO INITIALIZATION
      // ============================================
      const generateAlertSound = () => {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const duration = 0.5;
        const sampleRate = audioCtx.sampleRate;
        const buffer = audioCtx.createBuffer(1, duration * sampleRate, sampleRate);
        const data = buffer.getChannelData(0);
        
        // Generate siren sound (alternating frequencies)
        for (let i = 0; i < buffer.length; i++) {
          const t = i / sampleRate;
          const freq = Math.sin(t * 8) * 200 + 800; // Oscillate between 600-1000 Hz
          data[i] = Math.sin(2 * Math.PI * freq * t) * 0.3;
        }
        
        return buffer;
      };

      const initializeAudio = () => {
        try {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
          alertAudioBuffer = generateAlertSound();
          console.log('‚úì Alert audio initialized');
        } catch (err) {
          console.error('‚ùå Audio init failed:', err);
        }
      };

      // ============================================
      // SOCKET.IO CONNECTION
      // ============================================
      const socket = io({
        reconnection: true,
        reconnectionDelay: 2000,
        reconnectionAttempts: 10,
        timeout: 10000
      });

      socket.on('connect', () => {
        console.log('‚úì Socket.IO connected:', socket.id);
        const perawat = document.body.dataset.perawat || 'Unknown';
        socket.emit('join-monitoring', { 
          perawat: perawat,
          timestamp: new Date().toISOString() 
        });
      });

      socket.on('disconnect', () => {
        console.warn('‚ö†Ô∏è Socket.IO disconnected');
      });

      socket.on('connect_error', (error) => {
        console.error('‚ùå Socket connection error:', error.message);
      });

      // ‚úÖ Handle real-time fall alerts from Socket.IO
      socket.on('fall-alert', (alert) => {
        console.log('üö® FALL ALERT RECEIVED (Socket.IO):', {
          id: alert.id,
          nama: alert.nama_pasien,
          room: alert.room_id,
          time: alert.waktu
        });
        
        handleFallAlert(alert);
      });

      // ‚úÖ Handle acknowledgment broadcasts
      socket.on('fall-acknowledged-broadcast', (data) => {
        console.log('‚úÖ Fall acknowledged by another user:', data);
        const alertKey = `fall-${data.alertId}`;
        if (displayedAlerts.has(alertKey)) {
          closeFallAlert(data.alertId, false); // Close without sending acknowledge again
        }
      });

      // ============================================
      // CENTRALIZED FALL ALERT HANDLER
      // ============================================
      function handleFallAlert(alert) {
        if (!alert || !alert.nama_pasien) {
          console.error('‚ùå Invalid alert data');
          return;
        }
        
        const alertKey = `fall-${alert.id}`;
        const now = Date.now();
        
        // Check alert age first
        const alertTime = new Date(alert.waktu).getTime();
        const alertAge = now - alertTime;
        const fiveMinutes = 5 * 60 * 1000;
        
        if (alertAge > fiveMinutes) {
          console.log(`‚è≠Ô∏è Alert ${alert.id} too old (${Math.round(alertAge/60000)} mins), ignoring`);
          displayedAlerts.set(alertKey, { alert: alert, timestamp: now });
          markAlertAsDisplayed(alert.id);
          return;
        }
        
        // Duplicate check
        if (displayedAlerts.has(alertKey)) {
          const existing = displayedAlerts.get(alertKey);
          const timeSinceDisplay = now - existing.timestamp;
          
          if (timeSinceDisplay < 2000) {
            console.log(`‚è≠Ô∏è Duplicate alert ignored: ${alertKey}`);
            return;
          } else {
            displayedAlerts.delete(alertKey);
          }
        }
        
        // DOM check
        if (document.getElementById(`fall-alert-${alert.id}`)) {
          console.log(`‚è≠Ô∏è Alert ${alert.id} already in DOM`);
          return;
        }
        
        // Store with timestamp
        displayedAlerts.set(alertKey, { alert: alert, timestamp: now });
        
        // ‚úÖ FIXED: Only play if not already playing
        if (!isAudioPlaying) {
          playAlertSound();
        } else {
          console.log('üîä Audio already playing for other alerts');
        }
        
        showFallAlert(alert);
        
        // Browser notification
        if (Notification.permission === 'granted') {
          try {
            const notification = new Notification('üö® FALL ALERT!', {
              body: `${alert.nama_pasien} - Room ${alert.room_id}\nEMR: ${alert.emr_no}`,
              tag: alertKey,
              requireInteraction: true,
              vibrate: [200, 100, 200],
              renotify: false
            });
            
            notification.onclick = () => {
              window.focus();
              notification.close();
            };
          } catch (err) {
            console.error('‚ùå Notification error:', err);
          }
        }
        
        updateBadgeCount();
        markAlertAsDisplayed(alert.id);
        
        console.log(`‚úì Alert displayed: ${alertKey}, age: ${Math.round(alertAge/1000)}s`);
        
        // Auto-close after 2 minutes
        setTimeout(() => {
          const element = document.getElementById(`fall-alert-${alert.id}`);
          if (element && element.parentNode) {
            console.log('‚è±Ô∏è Auto-closing alert:', alert.id);
            closeFallAlert(alert.id, false);
          }
        }, 120000);
      }

      // ============================================
      // MARK ALERT AS DISPLAYED ON SERVER
      // ============================================
      function markAlertAsDisplayed(fallId) {
        fetch('/api/fall-detection/mark-displayed', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ fallIds: [fallId] })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            console.log(`‚úì Alert ${fallId} marked as displayed on server`);
          } else {
            console.warn('‚ö†Ô∏è Failed to mark as displayed:', data.error);
          }
        })
        .catch(err => {
          console.error('‚ùå Mark displayed error:', err);
        });
      }

      // ============================================
      // DATABASE POLLING (BACKUP MECHANISM)
      // ============================================
        if (fallCheckInterval) {
          clearInterval(fallCheckInterval);
        }
        
        fallCheckInterval = setInterval(async () => {
          const now = Date.now();
          const timeSinceLastPoll = now - lastPollTime;
          
          // Skip if too soon
          if (timeSinceLastPoll < 9000) {
            return;
          }
          
          lastPollTime = now;
          
          try {
            const res = await fetch('/api/fall-detection/latest');
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            
            const data = await res.json();
            
            if (data.success && data.falls && data.falls.length > 0) {
              console.log(`üìä [POLL] Found ${data.falls.length} NEW fall(s)`);
              console.log(`   Total today: ${data.totalToday}`);
              console.log(`   Already displayed: ${data.displayedCount}`);
              
              data.falls.forEach(fall => {
                const alertData = {
                  id: fall.id,
                  emr_no: fall.emr_no,
                  nama_pasien: fall.nama_pasien,
                  room_id: fall.room_id || `Room-${fall.emr_no}`,
                  heart_rate: fall.heart_rate,
                  blood_pressure: fall.sistolik && fall.diastolik 
                    ? `${fall.sistolik}/${fall.diastolik}` 
                    : 'N/A',
                  waktu: fall.waktu
                };
                
                handleFallAlert(alertData);
              });
            } else {
              console.log('üìä [POLL] No new falls');
            }
          } catch (err) {
            console.error('‚ö†Ô∏è [POLL] Error:', err.message);
          }
        }, 10000); // Poll every 10 seconds
        
        console.log('‚úì Fall detection polling started (10s interval)');
      }
      function startFallDetectionPolling() {
        if (fallCheckInterval) {
          clearInterval(fallCheckInterval);
        }
        
        fallCheckInterval = setInterval(async () => {
          const now = Date.now();
          const timeSinceLastPoll = now - lastPollTime;
          
          // ‚úÖ Ensure minimum 9 seconds between polls
          if (timeSinceLastPoll < 9000) {
            return;
          }
          
          lastPollTime = now;
          
          try {
            const res = await fetch('/api/fall-detection/latest');
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            
            const data = await res.json();
            
            if (data.success && data.falls && data.falls.length > 0) {
              console.log(`üìä [POLL] Found ${data.falls.length} NEW fall(s) from last 30 mins`);
              console.log(`   Total recent: ${data.totalRecent}`);
              console.log(`   Already displayed: ${data.displayedCount}`);
              
              // ‚úÖ FIX: Sort by time descending to show newest first
              const sortedFalls = data.falls.sort((a, b) => 
                new Date(b.waktu).getTime() - new Date(a.waktu).getTime()
              );
              
              sortedFalls.forEach(fall => {
                const alertData = {
                  id: fall.id,
                  emr_no: fall.emr_no,
                  nama_pasien: fall.nama_pasien,
                  room_id: fall.room_id || `Room-${fall.emr_no}`,
                  heart_rate: fall.heart_rate,
                  blood_pressure: fall.sistolik && fall.diastolik 
                    ? `${fall.sistolik}/${fall.diastolik}` 
                    : 'N/A',
                  waktu: fall.waktu
                };
                
                handleFallAlert(alertData);
              });
            } else {
              console.log('üìä [POLL] No new falls');
            }
          } catch (err) {
            console.error('‚ö†Ô∏è [POLL] Error:', err.message);
          }
        }, 10000); // Poll every 10 seconds
        
        console.log('‚úì Fall detection polling started (10s interval, 30min window)');
      }

      // ============================================
      // RESET DISPLAYED ALERTS (TESTING/ADMIN)
      // ============================================
      function resetDisplayedAlerts() {
        if (confirm('Reset all displayed alerts? This will show old alerts again.')) {
          fetch('/api/fall-detection/reset-displayed', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              console.log('‚úì Server-side displayed alerts reset');
              displayedAlerts.clear();
              console.log('‚úì Client-side displayed alerts cleared');
              alert(`Reset complete! Cleared ${data.clearedCount} alerts.`);
              
              // Force reload
              location.reload();
            }
          })
          .catch(err => {
            console.error('‚ùå Reset error:', err);
            alert('Failed to reset: ' + err.message);
          });
        }
      }

      // ============================================
      // SHOW FALL ALERT IN UI
      // ============================================
      function showFallAlert(alert) {
        const container = document.getElementById('fall-alert-container');
        if (!container) {
          console.error('‚ùå Alert container not found');
          return;
        }
        
        const alertId = `fall-alert-${alert.id}`;
        
        // Check if already in DOM
        if (document.getElementById(alertId)) {
          console.log(`‚è≠Ô∏è Alert DOM already exists: ${alertId}`);
          return;
        }
        
        const alertDiv = document.createElement('div');
        alertDiv.className = 'fall-alert';
        alertDiv.id = alertId;
        
        const waktu = new Date(alert.waktu);
        const waktuStr = waktu.toLocaleTimeString('id-ID', {
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
        
        alertDiv.innerHTML = `
          <div class="fall-alert-header">
            <div class="fall-alert-icon">‚ö†Ô∏è</div>
            <h3 class="fall-alert-title">FALL DETECTED!</h3>
          </div>
          
          <div class="fall-alert-body">
            <div class="fall-alert-info">
              <span class="fall-alert-label">üë§ Pasien:</span>
              <span class="fall-alert-value">${alert.nama_pasien}</span>
            </div>
            
            <div class="fall-alert-info">
              <span class="fall-alert-label">üè• Ruangan:</span>
              <span class="fall-alert-value">${alert.room_id}</span>
            </div>
            
            <div class="fall-alert-info">
              <span class="fall-alert-label">üìã EMR:</span>
              <span class="fall-alert-value">${alert.emr_no}</span>
            </div>
            
            <div class="fall-alert-info">
              <span class="fall-alert-label">üíì Heart Rate:</span>
              <span class="fall-alert-value">${alert.heart_rate || 'N/A'} bpm</span>
            </div>
            
            <div class="fall-alert-info">
              <span class="fall-alert-label">ü©∫ Blood Pressure:</span>
              <span class="fall-alert-value">${alert.blood_pressure || 'N/A'} mmHg</span>
            </div>
            
            <div class="fall-alert-info">
              <span class="fall-alert-label">üïê Waktu:</span>
              <span class="fall-alert-value">${waktuStr}</span>
            </div>
          </div>
          
          <div class="fall-alert-footer">
            <button class="fall-alert-btn btn-acknowledge" onclick="acknowledgeFallAlert(${alert.id})">
              ‚úì Acknowledge
            </button>
            <button class="fall-alert-btn btn-close" onclick="closeFallAlert(${alert.id}, false)">
              ‚úï Close
            </button>
          </div>
          
          <div class="fall-alert-timestamp">
            Alert received at ${new Date().toLocaleTimeString('id-ID')}
          </div>
        `;
        
        container.insertBefore(alertDiv, container.firstChild);
        activeAlertsCount++;
        updateBadgeCount();
      }

      // ============================================
      // ACKNOWLEDGE & CLOSE ALERTS
      // ============================================
      function acknowledgeFallAlert(alertId) {
        console.log('‚úì Acknowledging alert:', alertId);
        
        const perawat = document.body.dataset.perawat || 'Unknown';
        
        fetch(`/api/fall-detection/${alertId}/acknowledge`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            acknowledged_by: perawat,
            timestamp: new Date().toISOString()
          })
        })
        .then(res => res.json())
        .then(data => {
          console.log('‚úì Acknowledged:', data);
          // Emit to socket so other clients know
          socket.emit('acknowledge-fall', {
            alertId: alertId,
            acknowledgedBy: perawat
          });
        })
        .catch(err => console.error('‚ùå Acknowledge error:', err));
        
        closeFallAlert(alertId, true);
      }

      function closeFallAlert(alertId, sendAcknowledge = false) {
        const alertDiv = document.getElementById(`fall-alert-${alertId}`);
        if (!alertDiv) {
          console.log(`‚ÑπÔ∏è Alert ${alertId} already closed`);
          return;
        }
        
        alertDiv.style.animation = 'slideOut 0.3s ease-in';
        
        setTimeout(() => {
          alertDiv.remove();
          activeAlertsCount--;
          
          // Remove from tracking
          displayedAlerts.delete(`fall-${alertId}`);
          
          // Stop audio only if no more alerts
stopAlertSound();

// Jika masih ada alert lain, restart audio
if (activeAlertsCount > 0) {
  setTimeout(() => playAlertSound(), 500);
}

          
          updateBadgeCount();
        }, 300);
      }

      // ============================================
      // AUDIO FUNCTIONS
      // ============================================
      function playAlertSound() {
        if (!audioContext || !alertAudioBuffer) {
          console.warn('‚ö†Ô∏è Audio not initialized');
          initializeAudio();
          return;
        }
        
        // ‚úÖ Don't play if already playing
        if (isAudioPlaying) {
          console.log('üîä Audio already playing');
          return;
        }
        
        // Stop existing audio first (safety)
        if (audioSource) {
          stopAlertSound();
        }
        
        try {
          // Resume context if suspended
          if (audioContext.state === 'suspended') {
            audioContext.resume();
          }
          
          // Create and start source
          audioSource = audioContext.createBufferSource();
          audioSource.buffer = alertAudioBuffer;
          audioSource.loop = true; // Loop the sound
          audioSource.connect(audioContext.destination);
          audioSource.start(0);
          
          isAudioPlaying = true; // ‚úÖ Mark as playing
          
          console.log('üîä Alert sound started (looping)');
        } catch (err) {
          console.error('‚ùå Audio play error:', err);
          isAudioPlaying = false;
        }
      }

      function stopAlertSound() {
        if (audioSource) {
          try {
            audioSource.stop();
            audioSource.disconnect();
            console.log('üîá Alert sound stopped');
          } catch (err) {
            console.warn('‚ö†Ô∏è Audio stop error:', err);
          }
          audioSource = null;
        }
        
        isAudioPlaying = false; // ‚úÖ Mark as stopped
      }


      // ============================================
      // BADGE COUNT & TITLE UPDATE
      // ============================================
      function updateBadgeCount() {
        const count = activeAlertsCount;
        
        if ('setAppBadge' in navigator) {
          if (count === 0) {
            navigator.clearAppBadge();
          } else {
            navigator.setAppBadge(count);
          }
        }
        
        // Update document title
        if (count > 0) {
          document.title = `(${count}) üö® Fall Alert - Darsinurse`;
        } else {
          document.title = 'Darsinurse - Dashboard Monitoring';
        }
        
        console.log(`üìä Active alerts: ${count}`);
      }

      // ============================================
      // CLEANUP OLD ALERTS FROM MEMORY
      // ============================================
      setInterval(() => {
        const now = Date.now();
        const twoMinutesAgo = now - 120000; // 2 minutes instead of 5
        
        let cleanedCount = 0;
        displayedAlerts.forEach((value, key) => {
          if (value.timestamp < twoMinutesAgo) {
            displayedAlerts.delete(key);
            cleanedCount++;
          }
        });
        
        if (cleanedCount > 0) {
          console.log(`üßπ Cleaned up ${cleanedCount} old alert(s) from memory`);
        }
        
        // ‚úÖ Also limit total size
        if (displayedAlerts.size > 50) {
          const entries = Array.from(displayedAlerts.entries());
          entries.sort((a, b) => a[1].timestamp - b[1].timestamp);
          const toRemove = entries.slice(0, entries.length - 50);
          toRemove.forEach(([key]) => displayedAlerts.delete(key));
          console.log(`üßπ Trimmed displayedAlerts to 50 (removed ${toRemove.length})`);
        }
      }, 30000); // Every 30 seconds
      // ============================================
      // AUDIO UNLOCK
      // ============================================
      function unlockAudio() {
        if (audioUnlocked) return;
        
        initializeAudio();
        
        if (audioContext) {
          audioContext.resume().then(() => {
            audioUnlocked = true;
            console.log('‚úì Alert sounds enabled');
            
            // Remove banner if exists
            const banner = document.getElementById('audio-unlock-banner');
            if (banner) {
              banner.style.animation = 'slideUp 0.3s ease-in';
              setTimeout(() => banner.remove(), 300);
            }
          }).catch(err => {
            console.warn('‚ö†Ô∏è Audio unlock failed:', err);
          });
        }
      }

      // Multiple event listeners for audio unlock
      ['click', 'keydown', 'touchstart'].forEach(event => {
        document.addEventListener(event, unlockAudio, { once: true });
      });

      function showAudioUnlockBanner() {
        if (document.getElementById('audio-unlock-banner')) {
          return; // Already showing
        }
        
        const banner = document.createElement('div');
        banner.id = 'audio-unlock-banner';
        banner.style.cssText = `
          position: fixed;
          top: 70px;
          left: 50%;
          transform: translateX(-50%);
          background: #ff9800;
          color: white;
          padding: 12px 24px;
          border-radius: 8px;
          z-index: 9998;
          box-shadow: 0 4px 12px rgba(0,0,0,0.3);
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          animation: slideDown 0.3s ease-out;
        `;
        banner.innerHTML = 'üîä Klik di mana saja untuk mengaktifkan suara alert';
        
        banner.onclick = (e) => {
          e.stopPropagation();
          unlockAudio();
        };
        
        document.body.appendChild(banner);
        
        // Auto-remove after 10 seconds
        setTimeout(() => {
          if (banner.parentNode && !audioUnlocked) {
            banner.style.animation = 'slideUp 0.3s ease-in';
            setTimeout(() => banner.remove(), 300);
          }
        }, 10000);
      }

      // ============================================
      // TAB NAVIGATION
      // ============================================
      document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', function() {
          const tabName = this.dataset.tab;
          
          document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
          
          this.classList.add('active');
          document.getElementById(tabName).classList.add('active');
          
          if (tabName === 'rawat-jalan') {
            loadRawatJalanData();
          } else if (tabName === 'rawat-inap') {
            loadMetabaseDashboard();
          }
        });
      });

      // ============================================
      // RAWAT JALAN DATA LOADING
      // ============================================
      async function loadRawatJalanData() {
        try {
          console.log('üîÑ Loading Rawat Jalan data...');
          
          const statsResponse = await fetch('/api/statistics/today');
          const statsData = await statsResponse.json();
          
          if (statsData.success) {
            const totalVisitsEl = document.getElementById('total-visits');
            const totalMeasurementsEl = document.getElementById('total-measurements');
            
            if (totalVisitsEl) {
              totalVisitsEl.textContent = statsData.stats.totalVisits || 0;
            }
            
            if (totalMeasurementsEl) {
              totalMeasurementsEl.textContent = statsData.stats.totalMeasurements || 0;
            }
          }

          await loadVisitsData();
          await loadMeasurementsData();

          console.log('‚úì Rawat Jalan data loaded');
        } catch (err) {
          console.error('‚ùå Error loading data:', err);
        }
      }

      async function loadVisitsData() {
        try {
          const visitsResponse = await fetch('/api/visits/today');
          const visitsData = await visitsResponse.json();
          
          if (visitsData.success) {
            const tbody = document.getElementById('visits-table-body');
            
            if (!tbody) return;
            
            if (visitsData.visits.length === 0) {
              tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">Tidak ada data kunjungan hari ini</td></tr>';
            } else {
              tbody.innerHTML = visitsData.visits.map(visit => `
                <tr>
                  <td><strong>${visit.id_kunjungan}</strong></td>
                  <td>${visit.nama_pasien}</td>
                  <td>${visit.emr_pasien}</td>
                  <td>${visit.keluhan || '-'}</td>
                  <td>${visit.nama_perawat}</td>
                  <td><span class="badge-status badge-${visit.status}">${visit.status === 'aktif' ? 'Aktif' : 'Selesai'}</span></td>
                  <td><span class="badge bg-info">${visit.total_measurements} data</span></td>
                </tr>
              `).join('');
            }
          }
        } catch (err) {
          console.error('‚ùå Error loading visits:', err);
        }
      }

      async function loadMeasurementsData() {
        try {
          const measurementsResponse = await fetch('/api/measurements/today');
          const measurementsData = await measurementsResponse.json();
          
          if (measurementsData.success) {
            const tbody = document.getElementById('measurements-table-body');
            
            if (!tbody) return;
            
            const isAdmin = document.body.dataset.role === 'admin';
            const colspan = isAdmin ? '5' : '4';
            
            if (measurementsData.measurements.length === 0) {
              tbody.innerHTML = `<tr><td colspan="${colspan}" class="text-center text-muted py-4">Tidak ada pengukuran hari ini</td></tr>`;
            } else {
              tbody.innerHTML = measurementsData.measurements.map(m => {
                const perawatColumn = isAdmin ? `<td>${m.nama_perawat}</td>` : '';
                return `
                  <tr>
                    <td>${new Date(m.timestamp).toLocaleTimeString('id-ID')}</td>
                    <td>${m.nama_pasien}</td>
                    <td><span class="badge bg-success">${m.tipe_device}</span></td>
                    <td><strong>${m.data}</strong></td>
                    ${perawatColumn}
                  </tr>
                `;
              }).join('');
            }
          }
        } catch (err) {
          console.error('‚ùå Error loading measurements:', err);
        }
      }

      async function loadMetabaseDashboard() {
        const loadingDiv = document.getElementById('metabase-loading');
        const iframe = document.getElementById('metabase-iframe');
        
        if (!loadingDiv || !iframe) return;
        
        loadingDiv.style.display = 'flex';
        iframe.style.display = 'none';
        
        try {
          const response = await fetch('/api/metabase/rawat-inap-token');
          const data = await response.json();
          
          if (data.success && data.embedUrl) {
            iframe.src = data.embedUrl;
            
            iframe.onload = function() {
              setTimeout(() => {
                loadingDiv.style.display = 'none';
                iframe.style.display = 'block';
              }, 300);
            };
            
            setTimeout(() => {
              loadingDiv.style.display = 'none';
              iframe.style.display = 'block';
            }, 5000);
          } else {
            throw new Error(data.error || 'Invalid response');
          }
        } catch (err) {
          console.error('‚ùå Metabase error:', err);
          loadingDiv.innerHTML = `
            <div style="text-align: center; color: #dc3545;">
              <i class="fas fa-exclamation-circle" style="font-size: 48px;"></i>
              <p style="margin-top: 15px;"><strong>Gagal memuat dashboard</strong></p>
              <button onclick="loadMetabaseDashboard()" class="btn btn-sm btn-primary mt-3">
                <i class="fas fa-sync"></i> Coba Lagi
              </button>
            </div>
          `;
        }
      }

      // ============================================
      // PAGE INITIALIZATION
      // ============================================
      document.addEventListener('DOMContentLoaded', function() {
        console.log('‚úì Page loaded, initializing...');
        
        // Store user info in body dataset
        const navSection = document.querySelector('.nav-section span');
        if (navSection && navSection.textContent) {
          const perawatName = navSection.textContent.replace(/\s*<.*?>\s*/g, '').trim();
          document.body.dataset.perawat = perawatName;
        }
        
        // Get role from server-side template (you need to add this in your EJS)
        // For now, default to 'perawat'
        
        document.body.dataset.role = '<%= role %>';        
        console.log('üë§ User:', document.body.dataset.perawat);
        console.log('üîë Role:', document.body.dataset.role);
        
        // Request notification permission
        if ("Notification" in window && Notification.permission === "default") {
          Notification.requestPermission().then(permission => {
            console.log('üì¢ Notification permission:', permission);
          });
        }
        
        // Initialize audio context
        initializeAudio();
        
        // Start fall detection polling
        startFallDetectionPolling();
        
        // Show audio unlock banner after 3 seconds
        setTimeout(() => {
          if (!audioUnlocked) {
            showAudioUnlockBanner();
          }
        }, 3000);
        
        // Load initial data
        loadRawatJalanData();
        
        console.log('‚úì Dashboard initialized');
        console.log('‚úì Fall detection system ready');
      });

      // ============================================
      // CLEANUP ON PAGE UNLOAD
      // ============================================
      window.addEventListener('beforeunload', () => {
        if (fallCheckInterval) {
          clearInterval(fallCheckInterval);
        }
        stopAlertSound();
        if (audioContext) {
          audioContext.close();
        }
      });
    </script>
  </body>
  </html>