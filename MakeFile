# ============================================================
# DARSINURSE GATEWAY - Makefile
# Simplified Docker management commands
# ============================================================

.PHONY: help setup build up down restart logs clean status health backup restore install test migrate

.DEFAULT_GOAL := help

# Colors for terminal output
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[0;33m
BLUE := \033[0;36m
NC := \033[0m # No Color

# ============================================================
# MAIN COMMANDS
# ============================================================

help: ## üìö Show this help message
	@echo "$(BLUE)‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó$(NC)"
	@echo "$(BLUE)‚ïë   DARSINURSE GATEWAY - Available Commands     ‚ïë$(NC)"
	@echo "$(BLUE)‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù$(NC)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "$(GREEN)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(YELLOW)Examples:$(NC)"
	@echo "  make setup          # First time setup"
	@echo "  make up             # Start all services"
	@echo "  make logs-app       # View rawat-jalan logs"
	@echo "  make health         # Check all services"
	@echo ""

setup: ## üîß Initial setup (first time only)
	@echo "$(BLUE)üîß Setting up Darsinurse Gateway...$(NC)"
	@mkdir -p backups
	@mkdir -p rawat-jalan/views monitoring/views
	@echo "$(GREEN)‚úÖ Folder structure created$(NC)"
	@echo ""
	@echo "$(YELLOW)Next steps:$(NC)"
	@echo "1. Copy your existing files to rawat-jalan/"
	@echo "2. Create monitoring/monitoring-server.js"
	@echo "3. Run: make build"
	@echo "4. Run: make up"

# ============================================================
# DOCKER OPERATIONS
# ============================================================

build: ## üî® Build all Docker images
	@echo "$(BLUE)üî® Building Docker images...$(NC)"
	docker-compose build --no-cache
	@echo "$(GREEN)‚úÖ Build complete!$(NC)"

build-app: ## üî® Build Rawat Jalan only
	@echo "$(BLUE)üî® Building Rawat Jalan image...$(NC)"
	docker-compose build --no-cache darsinurse-app
	@echo "$(GREEN)‚úÖ Rawat Jalan built!$(NC)"

build-monitoring: ## üî® Build Monitoring only
	@echo "$(BLUE)üî® Building Monitoring image...$(NC)"
	docker-compose build --no-cache darsinurse-monitoring
	@echo "$(GREEN)‚úÖ Monitoring built!$(NC)"

up: ## üöÄ Start all services
	@echo "$(BLUE)üöÄ Starting all services...$(NC)"
	docker-compose up -d
	@echo ""
	@echo "$(GREEN)‚úÖ Services started!$(NC)"
	@echo ""
	@echo "$(BLUE)üìç Access URLs:$(NC)"
	@echo "   - Rawat Jalan:  http://localhost:4000"
	@echo "   - Monitoring:   http://localhost:5000"
	@echo "   - phpMyAdmin:   http://localhost:8080"
	@echo "   - Metabase:     http://localhost:3000"
	@echo ""
	@echo "$(YELLOW)üí° Tip: Run 'make logs' to view logs$(NC)"

up-dev: ## üöÄ Start in development mode (with logs)
	@echo "$(BLUE)üöÄ Starting in development mode...$(NC)"
	docker-compose up

down: ## ‚èπÔ∏è  Stop all services
	@echo "$(BLUE)‚èπÔ∏è  Stopping all services...$(NC)"
	docker-compose down
	@echo "$(GREEN)‚úÖ Services stopped!$(NC)"

restart: ## üîÑ Restart all services
	@echo "$(BLUE)üîÑ Restarting all services...$(NC)"
	docker-compose restart
	@echo "$(GREEN)‚úÖ Services restarted!$(NC)"

restart-app: ## üîÑ Restart Rawat Jalan only
	@echo "$(BLUE)üîÑ Restarting Rawat Jalan...$(NC)"
	docker-compose restart darsinurse-app
	@echo "$(GREEN)‚úÖ Rawat Jalan restarted!$(NC)"

restart-monitoring: ## üîÑ Restart Monitoring only
	@echo "$(BLUE)üîÑ Restarting Monitoring...$(NC)"
	docker-compose restart darsinurse-monitoring
	@echo "$(GREEN)‚úÖ Monitoring restarted!$(NC)"

restart-db: ## üîÑ Restart Database only
	@echo "$(BLUE)üîÑ Restarting Database...$(NC)"
	docker-compose restart darsinurse-db
	@echo "$(GREEN)‚úÖ Database restarted!$(NC)"

# ============================================================
# LOGS
# ============================================================

logs: ## üìã Show logs (all services, follow mode)
	docker-compose logs -f

logs-app: ## üìã Show Rawat Jalan logs
	docker-compose logs -f darsinurse-app

logs-monitoring: ## üìã Show Monitoring logs
	docker-compose logs -f darsinurse-monitoring

logs-db: ## üìã Show Database logs
	docker-compose logs -f darsinurse-db

logs-meta: ## üìã Show Metabase logs
	docker-compose logs -f metabase

logs-all: ## üìã Show all logs (no follow)
	docker-compose logs --tail=100

# ============================================================
# STATUS & HEALTH
# ============================================================

status: ## üìä Show status of all services
	@echo "$(BLUE)üìä Services Status:$(NC)"
	@docker-compose ps
	@echo ""

ps: status ## Alias for status

health: ## üè• Check health of all services
	@echo "$(BLUE)üè• Health Check:$(NC)"
	@echo ""
	@echo "$(YELLOW)MySQL Database:$(NC)"
	@docker exec darsinurse-db mysqladmin ping -h localhost -u root -proot123 2>/dev/null \
		&& echo "  $(GREEN)‚úÖ Healthy$(NC)" \
		|| echo "  $(RED)‚ùå Unhealthy$(NC)"
	@echo ""
	@echo "$(YELLOW)Rawat Jalan (Port 4000):$(NC)"
	@curl -sf http://localhost:4000/health > /dev/null 2>&1 \
		&& echo "  $(GREEN)‚úÖ Healthy$(NC)" \
		|| echo "  $(RED)‚ùå Unhealthy$(NC)"
	@echo ""
	@echo "$(YELLOW)Monitoring (Port 5000):$(NC)"
	@curl -sf http://localhost:5000/health > /dev/null 2>&1 \
		&& echo "  $(GREEN)‚úÖ Healthy$(NC)" \
		|| echo "  $(RED)‚ùå Unhealthy$(NC)"
	@echo ""
	@echo "$(YELLOW)phpMyAdmin (Port 8080):$(NC)"
	@curl -sf http://localhost:8080 > /dev/null 2>&1 \
		&& echo "  $(GREEN)‚úÖ Healthy$(NC)" \
		|| echo "  $(RED)‚ùå Unhealthy$(NC)"
	@echo ""
	@echo "$(YELLOW)Metabase (Port 3000):$(NC)"
	@curl -sf http://localhost:3000 > /dev/null 2>&1 \
		&& echo "  $(GREEN)‚úÖ Healthy$(NC)" \
		|| echo "  $(RED)‚ùå Unhealthy$(NC)"
	@echo ""

check: health ## Alias for health

info: ## ‚ÑπÔ∏è  Show detailed system info
	@echo "$(BLUE)‚ÑπÔ∏è  System Information:$(NC)"
	@echo ""
	@echo "$(YELLOW)Docker Version:$(NC)"
	@docker --version
	@echo ""
	@echo "$(YELLOW)Docker Compose Version:$(NC)"
	@docker-compose --version
	@echo ""
	@echo "$(YELLOW)Running Containers:$(NC)"
	@docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
	@echo ""
	@echo "$(YELLOW)Disk Usage:$(NC)"
	@docker system df
	@echo ""

# ============================================================
# DATABASE OPERATIONS
# ============================================================

backup: ## üíæ Backup MySQL database
	@echo "$(BLUE)üíæ Backing up database...$(NC)"
	@mkdir -p backups
	@docker exec darsinurse-db mysqldump -u root -proot123 darsinurse > backups/darsinurse_$(shell date +%Y%m%d_%H%M%S).sql
	@echo "$(GREEN)‚úÖ Backup saved to: backups/darsinurse_$(shell date +%Y%m%d_%H%M%S).sql$(NC)"
	@ls -lh backups/ | tail -5

backup-list: ## üìã List all backups
	@echo "$(BLUE)üìã Available backups:$(NC)"
	@ls -lh backups/*.sql 2>/dev/null || echo "No backups found"

restore: ## üì• Restore database from backup (use FILE=path/to/backup.sql)
	@if [ -z "$(FILE)" ]; then \
		echo "$(RED)‚ùå Please specify backup file:$(NC)"; \
		echo "   $(YELLOW)make restore FILE=backups/darsinurse_20250101_120000.sql$(NC)"; \
		exit 1; \
	fi
	@echo "$(BLUE)üì• Restoring database from $(FILE)...$(NC)"
	@docker exec -i darsinurse-db mysql -u root -proot123 darsinurse < $(FILE)
	@echo "$(GREEN)‚úÖ Database restored!$(NC)"

db-shell: ## üíª Open MySQL shell
	@echo "$(BLUE)üíª Opening MySQL shell...$(NC)"
	docker exec -it darsinurse-db mysql -u root -proot123 darsinurse

db-tables: ## üìä Show database tables
	@echo "$(BLUE)üìä Database Tables:$(NC)"
	@docker exec darsinurse-db mysql -u darsinurse -pdarsinurse123 darsinurse -e "SHOW TABLES;"

db-users: ## üë• Show users in database
	@echo "$(BLUE)üë• Users in Database:$(NC)"
	@docker exec darsinurse-db mysql -u darsinurse -pdarsinurse123 darsinurse -e "SELECT emr_perawat, nama, role FROM perawat;"

db-patients: ## üè• Show patients in database
	@echo "$(BLUE)üè• Patients in Database:$(NC)"
	@docker exec darsinurse-db mysql -u darsinurse -pdarsinurse123 darsinurse -e "SELECT emr_no, nama, jenis_kelamin, poli FROM pasien LIMIT 10;"

# ============================================================
# SHELL ACCESS
# ============================================================

shell-app: ## üíª Open shell in Rawat Jalan container
	@echo "$(BLUE)üíª Opening Rawat Jalan shell...$(NC)"
	docker exec -it darsinurse-app sh

shell-monitoring: ## üíª Open shell in Monitoring container
	@echo "$(BLUE)üíª Opening Monitoring shell...$(NC)"
	docker exec -it darsinurse-monitoring sh

shell-db: ## üíª Open shell in Database container
	@echo "$(BLUE)üíª Opening Database shell...$(NC)"
	docker exec -it darsinurse-db bash

# ============================================================
# DEVELOPMENT
# ============================================================

install: ## üì¶ Install dependencies locally (for development)
	@echo "$(BLUE)üì¶ Installing dependencies...$(NC)"
	@if [ -d "rawat-jalan" ]; then \
		cd rawat-jalan && npm install && echo "$(GREEN)‚úÖ Rawat Jalan dependencies installed$(NC)"; \
	else \
		echo "$(YELLOW)‚ö†Ô∏è  rawat-jalan folder not found$(NC)"; \
	fi
	@if [ -d "monitoring" ]; then \
		cd monitoring && npm install && echo "$(GREEN)‚úÖ Monitoring dependencies installed$(NC)"; \
	else \
		echo "$(YELLOW)‚ö†Ô∏è  monitoring folder not found$(NC)"; \
	fi

install-app: ## üì¶ Install Rawat Jalan dependencies only
	@echo "$(BLUE)üì¶ Installing Rawat Jalan dependencies...$(NC)"
	cd rawat-jalan && npm install
	@echo "$(GREEN)‚úÖ Dependencies installed$(NC)"

install-monitoring: ## üì¶ Install Monitoring dependencies only
	@echo "$(BLUE)üì¶ Installing Monitoring dependencies...$(NC)"
	cd monitoring && npm install
	@echo "$(GREEN)‚úÖ Dependencies installed$(NC)"

# ============================================================
# TESTING
# ============================================================

test: ## üß™ Run all tests
	@echo "$(BLUE)üß™ Running tests...$(NC)"
	@make test-app
	@make test-monitoring

test-app: ## üß™ Test Rawat Jalan
	@echo "$(BLUE)üß™ Testing Rawat Jalan...$(NC)"
	@curl -sf http://localhost:4000/health > /dev/null \
		&& echo "$(GREEN)‚úÖ Rawat Jalan is healthy$(NC)" \
		|| echo "$(RED)‚ùå Rawat Jalan is down$(NC)"

test-monitoring: ## üß™ Test Monitoring
	@echo "$(BLUE)üß™ Testing Monitoring...$(NC)"
	@curl -sf http://localhost:5000/health > /dev/null \
		&& echo "$(GREEN)‚úÖ Monitoring is healthy$(NC)" \
		|| echo "$(RED)‚ùå Monitoring is down$(NC)"

test-db: ## üß™ Test Database connection
	@echo "$(BLUE)üß™ Testing Database...$(NC)"
	@docker exec darsinurse-db mysqladmin ping -h localhost -u root -proot123 2>/dev/null \
		&& echo "$(GREEN)‚úÖ Database is healthy$(NC)" \
		|| echo "$(RED)‚ùå Database is down$(NC)"

# ============================================================
# CLEANUP
# ============================================================

clean: ## üßπ Stop and remove all containers, volumes
	@echo "$(BLUE)üßπ Cleaning up...$(NC)"
	@echo "$(YELLOW)‚ö†Ô∏è  This will remove ALL containers and volumes!$(NC)"
	@echo "$(YELLOW)‚ö†Ô∏è  Press Ctrl+C to cancel, or wait 5 seconds...$(NC)"
	@sleep 5
	docker-compose down -v
	@echo "$(GREEN)‚úÖ Cleanup complete!$(NC)"

clean-images: ## üßπ Remove all images
	@echo "$(BLUE)üßπ Removing Docker images...$(NC)"
	docker-compose down -v --rmi all
	@echo "$(GREEN)‚úÖ Images removed!$(NC)"

clean-all: ## üßπ Complete cleanup (containers, volumes, images, networks)
	@echo "$(RED)‚ö†Ô∏è  DANGER: This will remove EVERYTHING!$(NC)"
	@echo "$(YELLOW)   - All containers$(NC)"
	@echo "$(YELLOW)   - All volumes (including database data)$(NC)"
	@echo "$(YELLOW)   - All images$(NC)"
	@echo "$(YELLOW)   - All networks$(NC)"
	@echo ""
	@echo "$(YELLOW)Press Ctrl+C to cancel, or wait 10 seconds...$(NC)"
	@sleep 10
	docker-compose down -v --rmi all
	docker system prune -af --volumes
	@echo "$(GREEN)‚úÖ Complete cleanup done!$(NC)"

prune: ## üßπ Prune unused Docker resources
	@echo "$(BLUE)üßπ Pruning unused Docker resources...$(NC)"
	docker system prune -f
	@echo "$(GREEN)‚úÖ Prune complete!$(NC)"

# ============================================================
# MIGRATION HELPERS
# ============================================================

migrate: ## üîÑ Show migration guide
	@echo "$(BLUE)‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó$(NC)"
	@echo "$(BLUE)‚ïë         MIGRATION TO SEPARATE SERVERS          ‚ïë$(NC)"
	@echo "$(BLUE)‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù$(NC)"
	@echo ""
	@echo "$(YELLOW)Step-by-step guide:$(NC)"
	@echo ""
	@echo "1. $(GREEN)Setup folders$(NC)"
	@echo "   make setup"
	@echo ""
	@echo "2. $(GREEN)Copy existing files$(NC)"
	@echo "   - Move your server.js to rawat-jalan/"
	@echo "   - Create monitoring/monitoring-server.js"
	@echo ""
	@echo "3. $(GREEN)Build images$(NC)"
	@echo "   make build"
	@echo ""
	@echo "4. $(GREEN)Start services$(NC)"
	@echo "   make up"
	@echo ""
	@echo "5. $(GREEN)Test everything$(NC)"
	@echo "   make test"
	@echo ""
	@echo "For detailed guide, see: MIGRATION.md"
	@echo ""

validate: ## ‚úÖ Validate setup before starting
	@echo "$(BLUE)‚úÖ Validating setup...$(NC)"
	@echo ""
	@if [ ! -f "docker-compose.yml" ]; then \
		echo "$(RED)‚ùå docker-compose.yml not found$(NC)"; \
		exit 1; \
	else \
		echo "$(GREEN)‚úÖ docker-compose.yml found$(NC)"; \
	fi
	@if [ ! -d "rawat-jalan" ]; then \
		echo "$(RED)‚ùå rawat-jalan folder not found$(NC)"; \
		exit 1; \
	else \
		echo "$(GREEN)‚úÖ rawat-jalan folder found$(NC)"; \
	fi
	@if [ ! -d "monitoring" ]; then \
		echo "$(RED)‚ùå monitoring folder not found$(NC)"; \
		exit 1; \
	else \
		echo "$(GREEN)‚úÖ monitoring folder found$(NC)"; \
	fi
	@if [ ! -f "rawat-jalan/Dockerfile" ]; then \
		echo "$(YELLOW)‚ö†Ô∏è  rawat-jalan/Dockerfile not found$(NC)"; \
	else \
		echo "$(GREEN)‚úÖ rawat-jalan/Dockerfile found$(NC)"; \
	fi
	@if [ ! -f "monitoring/Dockerfile" ]; then \
		echo "$(YELLOW)‚ö†Ô∏è  monitoring/Dockerfile not found$(NC)"; \
	else \
		echo "$(GREEN)‚úÖ monitoring/Dockerfile found$(NC)"; \
	fi
	@echo ""
	@echo "$(GREEN)‚úÖ Validation complete!$(NC)"

# ============================================================
# QUICK ACTIONS
# ============================================================

quick-start: validate build up health ## üöÄ Quick start (validate + build + up + health)

quick-restart: down up health ## üîÑ Quick restart (down + up + health)

quick-clean: clean build up ## üßπ Clean rebuild (clean + build + up)

# ============================================================
# MONITORING & METRICS
# ============================================================

stats: ## üìä Show Docker stats
	@echo "$(BLUE)üìä Container Statistics:$(NC)"
	docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}\t{{.BlockIO}}"

top: ## üìä Show running processes in containers
	@echo "$(BLUE)üìä Running Processes:$(NC)"
	@echo ""
	@echo "$(YELLOW)Rawat Jalan:$(NC)"
	@docker top darsinurse-app 2>/dev/null || echo "  Not running"
	@echo ""
	@echo "$(YELLOW)Monitoring:$(NC)"
	@docker top darsinurse-monitoring 2>/dev/null || echo "  Not running"

inspect-app: ## üîç Inspect Rawat Jalan container
	docker inspect darsinurse-app

inspect-monitoring: ## üîç Inspect Monitoring container
	docker inspect darsinurse-monitoring

# ============================================================
# UTILITY
# ============================================================

urls: ## üîó Show all access URLs
	@echo "$(BLUE)üîó Access URLs:$(NC)"
	@echo ""
	@echo "$(GREEN)Rawat Jalan:$(NC)    http://localhost:4000"
	@echo "$(GREEN)Monitoring:$(NC)     http://localhost:5000"
	@echo "$(GREEN)phpMyAdmin:$(NC)     http://localhost:8080"
	@echo "$(GREEN)Metabase:$(NC)       http://localhost:3000"
	@echo ""

ports: ## üîå Show used ports
	@echo "$(BLUE)üîå Used Ports:$(NC)"
	@echo ""
	@docker-compose ps --format "table {{.Name}}\t{{.Ports}}"

version: ## üìå Show versions
	@echo "$(BLUE)üìå Darsinurse Gateway$(NC)"
	@echo "Version: 2.0.0"
	@echo "Build: $(shell date +%Y%m%d)"
	@echo ""
	@docker --version
	@docker-compose --version
	@node --version 2>/dev/null || echo "Node.js not installed locally"

# ============================================================
# END OF MAKEFILE
# ============================================================