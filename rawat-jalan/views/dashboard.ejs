<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Darsinurse Gateway - Dashboard</title>
  <link rel="icon" type="image/png" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üè•</text></svg>">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Socket.IO Client -->
  <script src="/socket.io/socket.io.js"></script>
  
  <style>
    :root {
      --primary-blue: #0056b3;
      --primary-green: #00B14F;
      --secondary-green: #008a3d;
      --secondary-teal: #20c997;
      --primary-dark: #003d7a;
      --light-bg: #f0f8f7;
      --dark-text: #1a3a3a;
      --gray-border: #e0e0e0;
      --success-green: #28a745;
      --danger-red: #dc3545;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: var(--dark-text);
      background: linear-gradient(135deg, #f0f8f7 0%, #e6f7ff 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .top-header {
      background: white;
      padding: 1rem 0;
      box-shadow: 0 2px 15px rgba(0,0,0,0.08);
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
    }

    .logo-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-info i {
      font-size: 32px;
      color: var(--primary-green);
    }

    .logo-info h1 {
      font-size: 24px;
      font-weight: 700;
      color: var(--dark-text);
      margin: 0;
    }

    .logo-info span {
      font-size: 13px;
      color: #666;
      font-weight: 500;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
      font-size: 14px;
      color: var(--dark-text);
    }

    .user-info .user-name {
      font-weight: 600;
    }

    .user-info a {
      color: var(--primary-blue);
      text-decoration: none;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .user-info a:hover {
      color: var(--primary-dark);
    }

    .user-info a.logout-btn {
      color: var(--danger-red);
    }

    .user-info a.logout-btn:hover {
      color: #c82333;
    }

    /* Main Content */
    .main-container {
      padding-top: 100px !important;
      flex: 1;
    }

    .card {
      border: none;
      border-radius: 20px;
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.08);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      margin-bottom: 24px;
      border: 1px solid rgba(0,0,0,0.05);
      overflow: hidden;
    }

    .card:hover {
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
      transform: translateY(-2px);
    }

    .card-header {
      border-bottom: none;
      background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-teal) 100%);
      color: white;
      font-weight: 700;
      padding: 18px 24px;
      font-size: 16px;
      letter-spacing: 0.3px;
    }

    .card-header i {
      margin-right: 10px;
      font-size: 18px;
    }

    .card-body {
      padding: 24px;
    }

    .measurement-card, .kunjungan-card {
      display: none;
      animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .measurement-card.active, .kunjungan-card.active {
      display: block;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .selection-card {
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-align: center;
      padding: 32px 20px;
      height: 100%;
      background: white;
      border-radius: 20px;
      border: 2px solid transparent;
    }

    .selection-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
      border-color: var(--secondary-teal);
    }

    .selection-card i {
      font-size: 52px;
      color: var(--secondary-teal);
      margin-bottom: 16px;
      transition: all 0.3s;
    }

    .selection-card:hover i {
      transform: scale(1.1);
    }

    .selection-card h5 {
      margin: 0 0 8px 0;
      color: var(--dark-text);
      font-weight: 700;
      font-size: 18px;
    }

    .selection-card small {
      color: #666;
      font-size: 13px;
    }

    .selection-card.kunjungan-card-select i {
      color: var(--primary-blue);
    }

    .selection-card.kunjungan-card-select:hover {
      border-color: var(--primary-blue);
    }

    .form-label {
      font-weight: 600;
      color: var(--dark-text);
      margin-bottom: 10px;
      font-size: 14px;
    }

    .form-control, .form-select {
      border: 2px solid var(--gray-border);
      border-radius: 12px;
      padding: 12px 16px;
      transition: all 0.3s ease;
      font-size: 14px;
    }

    .form-control:focus, .form-select:focus {
      border-color: var(--secondary-teal);
      box-shadow: 0 0 0 0.25rem rgba(32, 201, 151, 0.15);
      outline: none;
    }

    .form-control:disabled {
      background: #f5f5f5;
      cursor: not-allowed;
    }

    .btn {
      border-radius: 12px;
      font-weight: 600;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: none;
      padding: 12px 24px;
      font-size: 14px;
      letter-spacing: 0.3px;
    }

    .btn i {
      margin-right: 6px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-dark) 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(0, 86, 179, 0.2);
    }

    .btn-primary:hover:not(:disabled) {
      background: linear-gradient(135deg, var(--primary-dark) 0%, #002555 100%);
      color: white;
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 86, 179, 0.35);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success-green) 0%, #1e7e34 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(40, 167, 69, 0.2);
    }

    .btn-success:hover:not(:disabled) {
      background: linear-gradient(135deg, #1e7e34 0%, #155724 100%);
      color: white;
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(40, 167, 69, 0.35);
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--danger-red) 0%, #c82333 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(220, 53, 69, 0.2);
    }

    .btn-danger:hover:not(:disabled) {
      background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
      color: white;
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(220, 53, 69, 0.35);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }

    .btn:active:not(:disabled) {
      transform: translateY(-1px) scale(0.98);
    }

    .btn-back {
      background: #6c757d;
      color: white;
    }

    .btn-back:hover {
      background: #5a6268;
      color: white;
    }

    .alert {
      border-radius: 12px;
      border: none;
      padding: 14px 18px;
      font-size: 14px;
      margin-bottom: 18px;
      font-weight: 500;
    }

    .alert i {
      margin-right: 8px;
    }

    .alert-info {
      background: linear-gradient(135deg, #e7f3ff 0%, #cfe7ff 100%);
      color: var(--primary-blue);
      border-left: 4px solid var(--primary-blue);
    }

    .alert-success {
      background: linear-gradient(135deg, #e6f9e6 0%, #d4f4dd 100%);
      color: #28a745;
      border-left: 4px solid #28a745;
    }

    .alert-danger {
      background: linear-gradient(135deg, #ffe6e6 0%, #ffd4d4 100%);
      color: #dc3545;
      border-left: 4px solid #dc3545;
    }

    .alert-warning {
      background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%);
      color: #856404;
      border-left: 4px solid #ffc107;
    }

    .measurement-display {
      background: linear-gradient(135deg, #f0f8f7 0%, #e1f5f0 100%);
      border-radius: 16px;
      padding: 28px;
      text-align: center;
      margin: 18px 0;
      border: 3px solid var(--secondary-teal);
      box-shadow: 0 4px 20px rgba(32, 201, 151, 0.15);
    }

    .measurement-display h3 {
      font-size: 48px;
      font-weight: 800;
      color: var(--secondary-teal);
      margin: 12px 0;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.05);
    }

    .measurement-display small {
      color: #666;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .patient-info {
      background: linear-gradient(135deg, #e6f9e6 0%, #d4f4dd 100%);
      border-left: 4px solid #28a745;
      padding: 14px 18px;
      border-radius: 10px;
      margin-top: 12px;
      font-size: 14px;
      font-weight: 500;
    }

    .patient-info strong {
      color: #28a745;
      font-weight: 700;
    }

    #activity-log {
      background: #f9f9f9;
      border-radius: 12px;
      padding: 18px;
      max-height: 450px;
      overflow-y: auto;
      font-size: 12px;
      font-family: 'Courier New', monospace;
      border-left: 4px solid var(--secondary-teal);
      border: 1px solid #e0e0e0;
    }

    #activity-log::-webkit-scrollbar {
      width: 8px;
    }

    #activity-log::-webkit-scrollbar-track {
      background: #f0f0f0;
      border-radius: 4px;
    }

    #activity-log::-webkit-scrollbar-thumb {
      background: var(--secondary-teal);
      border-radius: 4px;
    }

    .log-time {
      color: var(--secondary-teal);
      font-weight: 700;
    }

    .log-success {
      color: var(--success-green);
    }

    .log-error {
      color: var(--danger-red);
    }

    /* ============================================ */
    /* FALL DETECTION ALERT STYLES - Improved */
    /* ============================================ */
    
    .fall-alert-container {
      position: fixed;
      top: 90px;
      right: 24px;
      z-index: 9999;
      max-width: 420px;
      width: 100%;
    }

    .fall-alert {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
      border: 3px solid #ff0000;
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 18px;
      box-shadow: 0 12px 50px rgba(255, 0, 0, 0.5);
      animation: slideInShake 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      position: relative;
      color: white;
    }

    @keyframes slideInShake {
      0% {
        transform: translateX(450px) rotate(5deg);
        opacity: 0;
      }
      50% {
        transform: translateX(-25px) rotate(-3deg);
      }
      75% {
        transform: translateX(15px) rotate(2deg);
      }
      100% {
        transform: translateX(0) rotate(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0) scale(1);
        opacity: 1;
      }
      to {
        transform: translateX(450px) scale(0.8);
        opacity: 0;
      }
    }

    .fall-alert-header {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 18px;
      padding-bottom: 18px;
      border-bottom: 2px solid rgba(255, 255, 255, 0.3);
    }

    .fall-alert-icon {
      font-size: 42px;
      animation: pulse 1.2s ease-in-out infinite;
      filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.5));
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.25);
        opacity: 0.7;
      }
    }

    .fall-alert-title {
      font-size: 22px;
      font-weight: 800;
      margin: 0;
      text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.4);
      letter-spacing: 0.5px;
    }

    .fall-alert-body {
      margin-bottom: 18px;
    }

    .fall-alert-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 14px;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.15);
    }

    .fall-alert-info:last-child {
      border-bottom: none;
    }

    .fall-alert-label {
      font-weight: 600;
      opacity: 0.95;
    }

    .fall-alert-value {
      font-weight: 800;
      background: rgba(255, 255, 255, 0.25);
      padding: 4px 12px;
      border-radius: 8px;
      backdrop-filter: blur(10px);
    }

    .fall-alert-footer {
      display: flex;
      gap: 12px;
    }

    .fall-alert-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-size: 14px;
      letter-spacing: 0.5px;
    }

    .btn-acknowledge {
      background: white;
      color: #ff6b6b;
      box-shadow: 0 4px 15px rgba(255, 255, 255, 0.3);
    }

    .btn-acknowledge:hover {
      background: #f5f5f5;
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(255, 255, 255, 0.4);
    }

    .btn-close {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(10px);
    }

    .btn-close:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: white;
    }

    .fall-alert-timestamp {
      font-size: 11px;
      opacity: 0.9;
      text-align: center;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(255, 255, 255, 0.25);
      font-weight: 500;
    }

    .footer {
      background: #2c3e50;
      color: white;
      padding: 20px 0;
      text-align: center;
      margin-top: auto;
    }

    .footer-content {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 18px;
    }

    .footer-logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .footer-logo i {
      font-size: 22px;
      color: var(--primary-green);
    }

    .footer p {
      margin: 0;
      font-size: 14px;
      opacity: 0.95;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .logo-info h1 {
        font-size: 18px;
      }
      
      .logo-info span {
        display: none;
      }
      
      .user-info {
        font-size: 12px;
        gap: 10px;
      }
      
      .card-header {
        font-size: 14px;
        padding: 14px 18px;
      }
      
      .measurement-display h3 {
        font-size: 38px;
      }
      
      .selection-card {
        padding: 24px 16px;
      }

      .selection-card i {
        font-size: 42px;
      }

      .footer-content {
        flex-direction: column;
        gap: 12px;
      }

      .fall-alert-container {
        left: 12px;
        right: 12px;
        top: 80px;
        max-width: none;
      }

      .fall-alert {
        padding: 20px;
      }
    }
  </style>
</head>
<body>

  <!-- Fall Alert Container -->
  <div class="fall-alert-container" id="fall-alert-container"></div>
  <!-- Header -->
  <header class="top-header">
    <div class="container-fluid">
      <div class="logo-header">
        <div class="logo-info">
          <i class="fas fa-heartbeat"></i>
          <div>
            <h1>Darsinurse Gateway</h1>
            <span>Medical IoT Platform</span>
          </div>
        </div>
        <div class="user-info">
          <span class="user-name">
            <i class="fas fa-user-nurse"></i> <%= nama_perawat || 'Perawat' %> (EMR: <%= emr_perawat %>)
          </span>
          <span>|</span>
          <a href="https://darsinurse.hint-lab.id" target="_blank">Monitoring</a>
          <span>|</span>
          <a href="/logout" class="logout-btn" onclick="return confirm('Yakin logout?')">
            <i class="fas fa-sign-out-alt"></i> Logout
          </a>
        </div>
      </div>
    </div>
  </header>

  <div class="container-fluid py-4 main-container">
    <div class="row">
      <!-- KOLOM KIRI: PILIHAN & FORMULIR -->
      <div class="col-lg-8">
        <!-- SELECTION MENU -->
        <div id="selection-menu">
          <div class="row">
            <div class="col-12 mb-3">
              <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> Pilih menu yang ingin dilakukan
              </div>
            </div>
            
            <!-- Buat Kunjungan Baru -->
            <div class="col-md-6 col-lg-3 mb-3">
              <div class="card selection-card kunjungan-card-select" data-action="kunjungan">
                <div class="card-body">
                  <i class="fas fa-calendar-plus"></i>
                  <h5>Kunjungan Baru</h5>
                  <small class="text-muted">Daftar Pasien</small>
                </div>
              </div>
            </div>

            <div class="col-md-6 col-lg-3 mb-3">
              <div class="card selection-card kunjungan-card-select" data-action="kelola-kunjungan">
                <div class="card-body">
                  <i class="fas fa-clipboard-check"></i>
                  <h5>Kelola Kunjungan</h5>
                  <small class="text-muted">Update Status</small>
                </div>
              </div>
            </div>

            <div class="col-md-6 col-lg-3 mb-3">
              <div class="card selection-card" data-action="glucose">
                <div class="card-body">
                  <i class="fas fa-droplet"></i>
                  <h5>Glukosa</h5>
                  <small class="text-muted">Gula Darah</small>
                </div>
              </div>
            </div>

            <div class="col-md-6 col-lg-3 mb-3">
              <div class="card selection-card" data-action="bp">
                <div class="card-body">
                  <i class="fas fa-heart-pulse"></i>
                  <h5>Tekanan Darah</h5>
                  <small class="text-muted">Blood Pressure</small>
                </div>
              </div>
            </div>

            <div class="col-md-6 col-lg-3 mb-3">
              <div class="card selection-card" data-action="hr">
                <div class="card-body">
                  <i class="fas fa-heart"></i>
                  <h5>Detak Jantung</h5>
                  <small class="text-muted">Heart Rate</small>
                </div>
              </div>
            </div>

            <div class="col-md-6 col-lg-3 mb-3">
              <div class="card selection-card" data-action="weight">
                <div class="card-body">
                  <i class="fas fa-weight-scale"></i>
                  <h5>Berat & BMI</h5>
                  <small class="text-muted">Weight & BMI</small>
                </div>
              </div>
            </div>
            <div class="col-md-6 col-lg-3 mb-3">
              <div class="card selection-card" data-action="mcu">
                <div class="card-body">
                  <i class="fas fa-notes-medical"></i>
                  <h5>MCU</h5>
                  <small class="text-muted">Medical Check Up</small>
                </div>
              </div>
            </div>

            <div class="col-md-6 col-lg-3 mb-3">
              <div class="card selection-card" data-action="print-mcu">
                <div class="card-body">
                  <i class="fas fa-print"></i>
                  <h5>Print MCU</h5>
                  <small class="text-muted">Cetak Hasil</small>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="card-kelola-kunjungan" class="kunjungan-card">
            <div class="card">
              <div class="card-header">
                <i class="fas fa-clipboard-check"></i> Kelola Status Kunjungan
              </div>
              <div class="card-body">
                <!-- Filter -->
                <div class="mb-3">
                  <label class="form-label">Filter Berdasarkan Pasien (Opsional)</label>
                  <select class="form-control" id="kelola-filter-pasien">
                    <option value="">-- Semua Pasien --</option>
                  </select>
                </div>

                <!-- Tabel Kunjungan -->
                <div class="table-responsive">
                  <table class="table table-hover" id="table-kunjungan">
                    <thead class="table-light">
                      <tr>
                        <th>ID</th>
                        <th>Pasien</th>
                        <th>Tanggal</th>
                        <th>Keluhan</th>
                        <th>Status</th>
                        <th>Aksi</th>
                      </tr>
                    </thead>
                    <tbody id="tbody-kunjungan">
                      <tr>
                        <td colspan="6" class="text-center text-muted">
                          <i class="fas fa-spinner fa-spin"></i> Memuat data...
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <div class="d-grid gap-2 mt-3">
                  <button type="button" class="btn btn-back" data-back-menu>
                    <i class="fas fa-arrow-left"></i> Kembali ke Menu
                  </button>
                </div>
                
                <div id="kelola-status" class="mt-3"></div>
              </div>
            </div>
          </div>

        <!-- KUNJUNGAN BARU FORM -->
        <div id="card-kunjungan" class="kunjungan-card">
          <div class="card">
            <div class="card-header">
              <i class="fas fa-calendar-plus"></i> Buat Kunjungan Baru
            </div>
            <div class="card-body">
              <form id="form-kunjungan">
                <div class="mb-3">
                  <label class="form-label">EMR Pasien (Angka)</label>
                  <input type="text" class="form-control" id="new-emr-pasien" placeholder="Contoh: 101" required>
                  <div id="kunjungan-patient-info"></div>
                </div>
                <div class="mb-3">
                  <label class="form-label">Keluhan Pasien</label>
                  <textarea class="form-control" id="new-keluhan" rows="3" placeholder="Masukkan keluhan pasien..."></textarea>
                </div>
              <div class="mb-3">
                <label class="form-label">Pilih Dokter (Opsional)</label>
                <select class="form-control" id="new-emr-dokter">
                  <option value="">-- Pilih Dokter --</option>
                </select>
                <small class="text-muted">Dokter yang menangani kunjungan ini</small>
              </div>
                <div class="d-grid gap-2">
                  <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i> Simpan Kunjungan
                  </button>
                  <button type="button" class="btn btn-back" data-back-menu>
                    <i class="fas fa-arrow-left"></i> Kembali ke Menu
                  </button>
                </div>
                <div id="kunjungan-status" class="mt-3"></div>
              </form>
            </div>
          </div>
        </div>

        <!-- FORM TAMBAH PASIEN BARU -->
        <div id="card-pasien-baru" class="kunjungan-card">
          <div class="card">
            <div class="card-header">
              <i class="fas fa-user-plus"></i> Daftar Pasien Baru
            </div>
            <div class="card-body">
              <div class="alert alert-info">
                <!-- <i class="fas fa-info-circle"></i> EMR akan di-generate otomatis dengan format <strong>YYYYMMDDNNN</strong> -->
                <i class="fas fa-info-circle"></i> Masukkan nomor EMR pasien
              </div>
              <form id="form-pasien-baru">
                <div class="mb-3">
                  <label class="form-label">EMR Pasien</label>
                  <input type="text" class="form-control" id="pasien-baru-emr" placeholder="Contoh: 123" required>
                  <small class="text-muted">Bisa angka apa saja</small>
                </div>
                <div class="mb-3">
                  <label class="form-label">Nama Lengkap</label>
                  <input type="text" class="form-control" id="pasien-baru-nama" placeholder="Nama lengkap pasien" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Tanggal Lahir</label>
                  <input type="date" class="form-control" id="pasien-baru-tgl-lahir" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Jenis Kelamin</label>
                  <select class="form-control" id="pasien-baru-jk" required>
                    <option value="">-- Pilih --</option>
                    <option value="L">Laki-laki</option>
                    <option value="P">Perempuan</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Poli</label>
                  <select class="form-control" id="pasien-baru-poli" required>
                    <option value="">-- Pilih Poli --</option>
                    <option value="MCU">MCU</option>
                    <option value="Poli Umum">Poli Umum</option>
                    <option value="Poli Gigi">Poli Gigi</option>
                    <option value="Poli Anak">Poli Anak</option>
                    <option value="Poli Mata">Poli Mata</option>
                    <option value="Poli THT">Poli THT</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Alamat</label>
                  <textarea class="form-control" id="pasien-baru-alamat" rows="3" placeholder="Alamat lengkap pasien"></textarea>
                </div>
                <div class="d-grid gap-2">
                  <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i> Daftar Pasien Baru
                  </button>
                  <button type="button" class="btn btn-back" id="btn-cancel-pasien-baru">
                    <i class="fas fa-arrow-left"></i> Batal
                  </button>
                </div>
                <div id="pasien-baru-status" class="mt-3"></div>
              </form>
            </div>
          </div>
        </div>

        <!-- GLUCOSE MEASUREMENT - VERSI MANUAL SEDERHANA -->
        <div id="card-glucose" class="measurement-card">
          <div class="card">
            <div class="card-header">
              <i class="fas fa-droplet"></i> Pengukuran Glukosa
            </div>
            <div class="card-body">
              <form id="form-glucose">
                <!-- DROPDOWN PASIEN -->
                <div class="mb-3">
                  <label class="form-label">Pilih Pasien</label>
                  <select class="form-control" id="glucose-emr-pasien" required>
                    <option value="">-- Pilih Pasien --</option>
                  </select>
                  <small class="text-muted">Pilih pasien yang akan diukur</small>
                  <div id="glucose-patient-info"></div>
                </div>

                <!-- DROPDOWN KUNJUNGAN -->
                <div class="mb-3">
                  <label class="form-label">Pilih Kunjungan</label>
                  <select class="form-control" id="glucose-id-kunjungan" required disabled>
                    <option value="">-- Pilih pasien terlebih dahulu --</option>
                  </select>
                  <small class="text-muted">Pilih kunjungan yang aktif</small>
                </div>

                <!-- INPUT MANUAL GLUKOSA -->
                <div class="mb-3">
                  <label class="form-label">Nilai Glukosa (mg/dL)</label>
                  <input 
                    type="number" 
                    class="form-control" 
                    id="glucose-input" 
                    placeholder="Contoh: 95" 
                    min="0" 
                    max="600" 
                    step="1" 
                    required>
                  <small class="text-muted">Masukkan nilai glukosa dalam satuan mg/dL</small>
                </div>
                
                <div class="d-grid gap-2">
                  <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i> Simpan Data Glukosa
                  </button>
                  <button type="button" class="btn btn-back" data-back-menu>
                    <i class="fas fa-arrow-left"></i> Kembali ke Menu
                  </button>
                </div>
                <div id="glucose-status" class="mt-3"></div>
              </form>
            </div>
          </div>
        </div>

        <!-- BLOOD PRESSURE MEASUREMENT -->
        <div id="card-bp" class="measurement-card">
          <div class="card">
            <div class="card-header">
              <i class="fas fa-heart-pulse"></i> Pengukuran Tekanan Darah
            </div>
            <div class="card-body">
              <form id="form-bp">
                <div class="mb-3">
                  <label class="form-label">Pilih Pasien</label>
                  <select class="form-control" id="bp-emr-pasien" required>
                    <option value="">-- Pilih Pasien --</option>
                  </select>
                  <div id="bp-patient-info"></div>
                </div>
                <div class="mb-3">
                  <label class="form-label">Pilih Kunjungan</label>
                  <select class="form-control" id="bp-id-kunjungan" required disabled>
                    <option value="">-- Pilih pasien terlebih dahulu --</option>
                  </select>
                </div>

                <div class="mb-3">
                  <label class="form-label">Tekanan Darah (mmHg)</label>
                  <div class="measurement-display">
                    <small>Systolic / Diastolic</small>
                    <h3 id="bp-value">-</h3>
                    <small>mmHg</small>
                  </div>
                </div>
                <div class="d-grid gap-2">
                  <button type="button" class="btn btn-primary" id="btn-scan-bp" disabled>
                    <i class="fa-brands fa-bluetooth"></i> Scan Tensimeter
                  </button>
                  <button type="submit" class="btn btn-success" id="btn-save-bp" disabled>
                    <i class="fas fa-save"></i> Simpan Data Tensi
                  </button>
                  <button type="button" class="btn btn-danger btn-sm" id="btn-stop-bp" disabled>
                    <i class="fas fa-stop"></i> Stop Koneksi
                  </button>
                  <button type="button" class="btn btn-back" data-back-menu>
                    <i class="fas fa-arrow-left"></i> Kembali ke Menu
                  </button>
                </div>
                <div id="bp-status" class="mt-3"></div>
              </form>
            </div>
          </div>
        </div>

        <!-- HEART RATE MEASUREMENT -->
        <div id="card-hr" class="measurement-card">
          <div class="card">
            <div class="card-header">
              <i class="fas fa-heart"></i> Pengukuran Detak Jantung
            </div>
            <div class="card-body">
              <form id="form-hr">
                <div class="mb-3">
                  <label class="form-label">Pilih Pasien</label>
                  <select class="form-control" id="hr-emr-pasien" required>
                    <option value="">-- Pilih Pasien --</option>
                  </select>
                  <div id="hr-patient-info"></div>
                </div>
                <div class="mb-3">
                  <label class="form-label">Pilih Kunjungan</label>
                  <select class="form-control" id="hr-id-kunjungan" required disabled>
                    <option value="">-- Pilih pasien terlebih dahulu --</option>
                  </select>
                </div>

                <div class="mb-3">
                  <label class="form-label">Detak Jantung (bpm)</label>
                  <div class="measurement-display">
                    <small>Heart Rate</small>
                    <h3 id="hr-value">-</h3>
                    <small>bpm</small>
                  </div>
                </div>
                <div class="d-grid gap-2">
                  <button type="button" class="btn btn-primary" id="btn-scan-hr" disabled>
                    <i class="fa-brands fa-bluetooth"></i> Scan Heart Rate Monitor
                  </button>
                  <button type="submit" class="btn btn-success" id="btn-save-hr" disabled>
                    <i class="fas fa-save"></i> Simpan Data Heart Rate
                  </button>
                  <button type="button" class="btn btn-danger btn-sm" id="btn-stop-hr" disabled>
                    <i class="fas fa-stop"></i> Stop Koneksi
                  </button>
                  <button type="button" class="btn btn-back" data-back-menu>
                    <i class="fas fa-arrow-left"></i> Kembali ke Menu
                  </button>
                </div>
                <div id="hr-status" class="mt-3"></div>
              </form>
            </div>
          </div>
        </div>

        <!-- WEIGHT MEASUREMENT -->
        <div id="card-weight" class="measurement-card">
          <div class="card">
            <div class="card-header">
              <i class="fas fa-weight-scale"></i> Pengukuran Berat & BMI
            </div>
            <div class="card-body">
              <form id="form-weight">
                <div class="mb-3">
                  <label class="form-label">Pilih Pasien</label>
                  <select class="form-control" id="weight-emr-pasien" required>
                    <option value="">-- Pilih Pasien --</option>
                  </select>
                  <div id="weight-patient-info"></div>
                </div>
                <div class="mb-3">
                  <label class="form-label">Pilih Kunjungan</label>
                  <select class="form-control" id="weight-id-kunjungan" required disabled>
                    <option value="">-- Pilih pasien terlebih dahulu --</option>
                  </select>
                </div>

                <div class="mb-3">
                  <label class="form-label">Tinggi Badan (cm)</label>
                  <input type="number" class="form-control" id="weight-height" placeholder="Contoh: 170" min="50" max="250" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Berat Badan (kg)</label>
                  <div class="measurement-display">
                    <small>Berat Badan</small>
                    <h3 id="weight-value">-</h3>
                    <small>kg</small>
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">BMI (Body Mass Index)</label>
                  <div class="measurement-display">
                    <small>BMI</small>
                    <h3 id="bmi-value">-</h3>
                    <small id="bmi-category"></small>
                  </div>
                </div>
                <div class="d-grid gap-2">
                  <button type="button" class="btn btn-primary" id="btn-scan-weight" disabled>
                    <i class="fa-brands fa-bluetooth"></i> Scan Timbangan
                  </button>
                  <button type="submit" class="btn btn-success" id="btn-save-weight" disabled>
                    <i class="fas fa-save"></i> Simpan Data Berat & BMI
                  </button>
                  <button type="button" class="btn btn-danger btn-sm" id="btn-stop-weight" disabled>
                    <i class="fas fa-stop"></i> Stop Koneksi
                  </button>
                  <button type="button" class="btn btn-back" data-back-menu>
                    <i class="fas fa-arrow-left"></i> Kembali ke Menu
                  </button>
                </div>
                <div id="weight-status" class="mt-3"></div>
              </form>
            </div>
          </div>
        </div>

        <!-- MCU FORM -->
        <div id="card-mcu" class="measurement-card">
          <!-- FORM DAFTAR PASIEN BARU (INLINE di MCU) -->
          <div id="mcu-patient-registration" style="display:none;" class="mb-4 p-3 border rounded bg-light">
            <h6 class="mb-3"><i class="fas fa-user-plus"></i> Daftar Pasien Baru</h6>
            
            <div class="mb-2">
              <label class="form-label">EMR Pasien</label>
              <input type="text" class="form-control" id="mcu-new-emr" readonly style="background-color: #e9ecef;">
            </div>
            
            <div class="mb-2">
              <label class="form-label">Nama Lengkap</label>
              <input type="text" class="form-control" id="mcu-new-nama" placeholder="Nama lengkap pasien" required>
            </div>
            
            <div class="mb-2">
              <label class="form-label">Tanggal Lahir</label>
              <input type="date" class="form-control" id="mcu-new-tgl-lahir" required>
            </div>
            
            <div class="mb-2">
              <label class="form-label">Jenis Kelamin</label>
              <select class="form-control" id="mcu-new-jk" required>
                <option value="">-- Pilih --</option>
                <option value="L">Laki-laki</option>
                <option value="P">Perempuan</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label class="form-label">Alamat</label>
              <textarea class="form-control" id="mcu-new-alamat" rows="2" placeholder="Alamat lengkap pasien"></textarea>
            </div>
            
            <div class="d-grid gap-2">
              <button type="button" class="btn btn-success" onclick="registerMCUPatient()">
                <i class="fas fa-save"></i> Simpan Pasien
              </button>
              <button type="button" class="btn btn-secondary" onclick="cancelMCUPatientForm()">
                <i class="fas fa-times"></i> Batal
              </button>
            </div>
            
            <div id="mcu-registration-status" class="mt-2"></div>
          </div>

          <div class="card">
            <div class="card-header">
              <i class="fas fa-notes-medical"></i> Medical Check Up (MCU)
            </div>
            <div class="card-body">
              <form id="form-mcu">
                <!-- Input EMR Pasien -->
                <div class="mb-3">
                  <label class="form-label">EMR Pasien</label>
                  <input type="text" class="form-control" id="mcu-emr-pasien" placeholder="Masukkan EMR" required>
                  <small class="text-muted">Ketik EMR dan tekan Enter atau klik di luar kotak</small>
                  
                  <!-- Patient Info Display -->
                  <div id="mcu-patient-info" class="mt-2"></div>
                  
                  <!-- Button untuk tambah pasien baru -->
                  <div id="mcu-add-patient-btn" style="display:none;" class="mt-2">
                    <button type="button" class="btn btn-primary btn-sm" onclick="showMCUPatientForm()">
                      <i class="fas fa-user-plus"></i> Daftar Pasien Baru
                    </button>
                  </div>
                </div>
                <!-- Waktu -->
                <div class="mb-3">
                  <label class="form-label">Waktu Pemeriksaan</label>
                  <input type="datetime-local" class="form-control" id="mcu-waktu" required>
                </div>

                <hr>
                <h6 class="mb-3"><i class="fas fa-heartbeat"></i> Vital Signs</h6>

                <!-- Heart Rate -->
                <div class="row mb-3">
                  <div class="col-md-8">
                    <label class="form-label">Heart Rate (bpm)</label>
                    <input type="number" class="form-control" id="mcu-heart-rate" placeholder="Contoh: 75">
                    <small id="mcu-hr-source" class="text-success" style="display:none;">
                      <i class="fas fa-check-circle"></i> Data dari Bluetooth
                    </small>
                  </div>
                  <div class="col-md-4 d-grid align-items-end">
                    <button type="button" class="btn btn-primary btn-sm" id="btn-scan-mcu-hr">
                      <i class="fa-brands fa-bluetooth"></i> Scan
                    </button>
                  </div>
                </div>

                <!-- Add this after the button -->
                <div class="mb-2">
                  <small id="mcu-hr-status" class="text-muted"></small>
                </div>


                <!-- Respirasi -->
                <div class="mb-3">
                  <label class="form-label">Respirasi (per menit)</label>
                  <input type="number" class="form-control" id="mcu-respirasi" placeholder="Contoh: 18" required>
                </div>

                <!-- Glukosa -->
                <div class="row mb-3">
                  <div class="col-md-8">
                    <label class="form-label">Glukosa (mg/dL)</label>
                    <input type="number" class="form-control" id="mcu-glucose" placeholder="Contoh: 95">
                    <small id="mcu-glucose-source" class="text-success" style="display:none;">
                      <i class="fas fa-check-circle"></i> Data dari Bluetooth
                    </small>
                  </div>
                  <div class="col-md-4 d-grid align-items-end">
                    <button type="button" class="btn btn-primary btn-sm" id="btn-scan-mcu-glucose">
                      <i class="fa-brands fa-bluetooth"></i> Scan
                    </button>
                  </div>
                </div>
                <div class="mb-3">
                  <small id="mcu-glucose-status" class="text-muted"></small>
                </div>

                <!-- Berat Badan -->
                <div class="row mb-3">
                  <div class="col-md-8">
                    <label class="form-label">Berat Badan (kg)</label>
                    <input type="number" step="0.1" class="form-control" id="mcu-weight" placeholder="Contoh: 65">
                    <small id="mcu-weight-source" class="text-success" style="display:none;">
                      <i class="fas fa-check-circle"></i> Data dari Bluetooth
                    </small>
                  </div>
                  <div class="col-md-4 d-grid align-items-end">
                    <button type="button" class="btn btn-primary btn-sm" id="btn-scan-mcu-weight">
                      <i class="fa-brands fa-bluetooth"></i> Scan
                    </button>
                  </div>
                </div>
                <div class="mb-3">
                  <small id="mcu-weight-status" class="text-muted"></small>
                </div>


                <!-- Tinggi Badan -->
                <div class="mb-3">
                  <label class="form-label">Tinggi Badan (cm)</label>
                  <input type="number" class="form-control" id="mcu-height" placeholder="Contoh: 170" required>
                </div>

                <!-- BMI (Auto Calculate) -->
                <div class="mb-3">
                  <label class="form-label">BMI (kg/m¬≤)</label>
                  <input type="text" class="form-control" id="mcu-bmi" disabled placeholder="Otomatis terhitung..." style="background-color: #e9ecef; font-weight: bold;">
                </div>

                <!-- Tekanan Darah -->
                <div class="row mb-3">
                  <div class="col-md-4">
                    <label class="form-label">Sistolik (mmHg)</label>
                    <input type="number" class="form-control" id="mcu-sistolik" placeholder="120">
                    <small id="mcu-bp-source" class="text-success" style="display:none;">
                      <i class="fas fa-check-circle"></i> Bluetooth
                    </small>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Diastolik (mmHg)</label>
                    <input type="number" class="form-control" id="mcu-diastolik" placeholder="80">
                  </div>
                  <div class="col-md-4 d-grid align-items-end">
                    <button type="button" class="btn btn-primary btn-sm" id="btn-scan-mcu-bp">
                      <i class="fa-brands fa-bluetooth"></i> Scan
                    </button>
                  </div>
                </div>
                <div class="mb-3">
                  <small id="mcu-bp-status" class="text-muted"></small>
                </div>

                <!-- Kolesterol -->
                <div class="mb-3">
                  <label class="form-label">Kolesterol (mg/dL)</label>
                  <input type="number" class="form-control" id="mcu-cholesterol" placeholder="Contoh: 200" required>
                </div>

                <!-- Asam Urat -->
                <div class="mb-3">
                  <label class="form-label">Asam Urat (mg/dL)</label>
                  <input type="number" step="0.1" class="form-control" id="mcu-asam-urat" placeholder="Contoh: 5.5" required>
                </div>

                <!-- Buttons -->
                <div class="d-grid gap-2">
                  <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i> Simpan Data MCU
                  </button>
                  <button type="button" class="btn btn-back" data-back-menu>
                    <i class="fas fa-arrow-left"></i> Kembali ke Menu
                  </button>
                </div>
                <div id="mcu-status" class="mt-3"></div>
              </form>
            </div>
          </div>
        </div>

        <!-- PRINT MCU -->
        <div id="card-print-mcu" class="measurement-card">
          <div class="card">
            <div class="card-header">
              <i class="fas fa-print"></i> Cetak Hasil MCU
            </div>
            <div class="card-body">
              <form id="form-print-mcu">
                <div class="mb-3">
                  <label class="form-label">Pilih EMR Pasien</label>
                  <select class="form-control" id="print-mcu-emr" required>
                    <option value="">-- Pilih Pasien --</option>
                  </select>
                </div>

                <div class="mb-3">
                  <label class="form-label">Pilih Data MCU</label>
                  <select class="form-control" id="print-mcu-data" required disabled>
                    <option value="">-- Pilih EMR terlebih dahulu --</option>
                  </select>
                </div>

                <div id="print-mcu-preview" class="alert alert-info" style="display:none;">
                  <strong>Preview Data:</strong>
                  <div id="print-mcu-detail"></div>
                </div>

                <div class="d-grid gap-2">
                  <button type="button" class="btn btn-primary" id="btn-print-mcu">
                    <i class="fas fa-print"></i> Cetak Surat MCU
                  </button>
                  <button type="button" class="btn btn-back" data-back-menu>
                    <i class="fas fa-arrow-left"></i> Kembali ke Menu
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

      </div>
      <!-- KOLOM KANAN: LOG AKTIVITAS -->
      <div class="col-lg-4">
        <div class="card">
          <div class="card-header">
            <i class="fas fa-list"></i> Log Aktivitas
          </div>
          <div class="card-body">
            <div id="activity-log">
              <small class="text-muted">Aktivitas akan muncul di sini...</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-logo">
          <i class="fas fa-flask"></i>
          <strong>Hint-lab Team</strong>
        </div>
        <span>|</span>
        <p>&copy; 2025 Darsinurse Gateway. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <script>
    // ============================================
    // DARSINURSE GATEWAY - Complete Dashboard Script
    // ============================================

    // ============================================
    // SOCKET.IO CLIENT
    // ============================================
    const socket = io({
      reconnection: true,
      reconnectionDelay: 1000,
      reconnectionAttempts: 5
    });

    socket.on('connect', () => {
      console.log('‚úì Socket.IO connected:', socket.id);
      socket.emit('join-monitoring', { 
        user: '<%= nama_perawat %>', 
        role: 'perawat'
      });
    });

    socket.on('disconnect', () => {
      console.log('‚ùå Socket.IO disconnected');
    });

    socket.on('connect_error', (error) => {
      console.error('‚ùå Socket.IO connection error:', error);
    });

    socket.on('fall-alert', (alert) => {
      console.log('üö® FALL ALERT RECEIVED:', alert);
      playAlertSound();
      showFallAlert(alert);
      addLog(`üö® FALL DETECTED: ${alert.nama_pasien} - Room ${alert.room_id}`, 'error');
    });

    // ============================================
    // GLOBAL STATE
    // ============================================
    let audioUnlocked = false;
    let currentAlertAudio = null;

    const activityLog = document.getElementById('activity-log');
    const emrPerawat = <%= emr_perawat %>;

    let currentDevices = {
      glucose: null,
      bp: null,
      hr: null,
      weight: null
    };

    let measurementData = {
      glucose: null,
      bp: null,
      hr: null,
      weight: null,
      height: null,
      bmi: null
    };

    let currentPatients = {
      glucose: null,
      bp: null,
      hr: null,
      weight: null
    };

    let currentVisits = {
      glucose: null,
      bp: null,
      hr: null,
      weight: null
    };

    let currentDoctors = {
      glucose: null,
      bp: null,
      hr: null,
      weight: null
    };

    // ============================================
    // BLUETOOTH GATT UUIDs
    // ============================================
    const BLOOD_PRESSURE_SERVICE = 0x1810;
    const HEART_RATE_SERVICE = 0x180D;
    const WEIGHT_SCALE_SERVICE = 0x181D;
    const GLUCOSE_SERVICE = 0x1808;

    const BP_MEASUREMENT_CHAR = 0x2A35;
    const HR_MEASUREMENT_CHAR = 0x2A37;
    const WEIGHT_MEASUREMENT_CHAR = 0x2A9D;
    const GLUCOSE_MEASUREMENT_CHAR = 0x2A18;

    // ============================================
    // AUDIO FUNCTIONS
    // ============================================
    function unlockAudio() {
      if (audioUnlocked) return;
      const audio = document.getElementById('fall-alert-sound');
      if (audio) {
        audio.play()
          .then(() => {
            audio.pause();
            audio.currentTime = 0;
            audioUnlocked = true;
            console.log('‚úì Alert sounds enabled');
          })
          .catch(() => {});
      }
    }

    ['click', 'keydown', 'touchstart', 'mousedown'].forEach(event => {
      document.addEventListener(event, unlockAudio, { once: true });
    });

    function playAlertSound() {
      const audio = document.getElementById('fall-alert-sound');
      if (!audio) return;
      currentAlertAudio = audio;
      audio.loop = true;
      audio.play()
        .then(() => console.log('üîä Alert sound looping'))
        .catch(() => {
          console.warn('‚ö†Ô∏è Click anywhere to enable sound');
          const retryPlay = () => {
            audio.play().then(() => console.log('‚úì Alert sound now looping'));
            document.removeEventListener('click', retryPlay);
          };
          document.addEventListener('click', retryPlay, { once: true });
        });
    }

    function stopAlertSound() {
      if (currentAlertAudio) {
        currentAlertAudio.pause();
        currentAlertAudio.currentTime = 0;
        currentAlertAudio.loop = false;
      }
    }

    // ============================================
    // FALL ALERT UI
    // ============================================
    function showFallAlert(alert) {
      const container = document.getElementById('fall-alert-container');
      if (!container) return;
      
      const alertDiv = document.createElement('div');
      alertDiv.className = 'fall-alert';
      alertDiv.id = `fall-alert-${alert.id}`;
      
      const waktu = new Date(alert.waktu);
      const waktuStr = waktu.toLocaleTimeString('id-ID', {
        hour: '2-digit', minute: '2-digit', second: '2-digit'
      });
      
      alertDiv.innerHTML = `
        <div class="fall-alert-header">
          <div class="fall-alert-icon">‚ö†Ô∏è</div>
          <h3 class="fall-alert-title">FALL DETECTED!</h3>
        </div>
        <div class="fall-alert-body">
          <div class="fall-alert-info">
            <span class="fall-alert-label">üë§ Pasien:</span>
            <span class="fall-alert-value">${alert.nama_pasien}</span>
          </div>
          <div class="fall-alert-info">
            <span class="fall-alert-label">üè• Ruangan:</span>
            <span class="fall-alert-value">${alert.room_id}</span>
          </div>
          <div class="fall-alert-info">
            <span class="fall-alert-label">üìã EMR:</span>
            <span class="fall-alert-value">${alert.emr_no}</span>
          </div>
          <div class="fall-alert-info">
            <span class="fall-alert-label">üíì Heart Rate:</span>
            <span class="fall-alert-value">${alert.heart_rate || 'N/A'} bpm</span>
          </div>
          <div class="fall-alert-info">
            <span class="fall-alert-label">ü©∫ Blood Pressure:</span>
            <span class="fall-alert-value">${alert.blood_pressure || 'N/A'} mmHg</span>
          </div>
          <div class="fall-alert-info">
            <span class="fall-alert-label">üïê Waktu:</span>
            <span class="fall-alert-value">${waktuStr}</span>
          </div>
        </div>
        <div class="fall-alert-footer">
          <button class="fall-alert-btn btn-acknowledge" onclick="acknowledgeFallAlert(${alert.id})">
            ‚úì Acknowledge
          </button>
          <button class="fall-alert-btn btn-close" onclick="closeFallAlert(${alert.id})">
            ‚úï Close
          </button>
        </div>
        <div class="fall-alert-timestamp">
          Alert received at ${new Date().toLocaleTimeString('id-ID')}
        </div>
      `;
      
      container.insertBefore(alertDiv, container.firstChild);
      setTimeout(() => closeFallAlert(alert.id), 120000);
    }
    // ‚úÖ GANTI DENGAN INI (hanya client-side)
    function acknowledgeFallAlert(alertId) {
      console.log('‚úì Acknowledging alert:', alertId);
      stopAlertSound();
      
      if (currentAlertAudio) {
        currentAlertAudio.pause();
        currentAlertAudio.currentTime = 0;
        currentAlertAudio.onended = null;
      }
      
      addLog(`Alert ${alertId} acknowledged by <%= nama_perawat %>`, 'success');
      closeFallAlert(alertId);
    }

    function closeFallAlert(alertId) {
      stopAlertSound();
      if (currentAlertAudio) {
        currentAlertAudio.pause();
        currentAlertAudio.currentTime = 0;
        currentAlertAudio.onended = null;
      }
      
      const alertDiv = document.getElementById(`fall-alert-${alertId}`);
      if (alertDiv) {
        alertDiv.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => alertDiv.remove(), 300);
      }
    }

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    function addLog(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString('id-ID');
      const logClass = type === 'success' ? 'log-success' : type === 'error' ? 'log-error' : '';
      const icon = type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚Üí';
      
      const logEntry = document.createElement('div');
      logEntry.innerHTML = `<span class="log-time">[${timestamp}]</span> <span class="${logClass}">${icon} ${message}</span>`;
      
      activityLog.insertBefore(logEntry, activityLog.firstChild);
      while (activityLog.children.length > 50) {
        activityLog.removeChild(activityLog.lastChild);
      }
    }

    function showStatus(type, message, alertType = 'info') {
      const statusDiv = document.getElementById(`${type}-status`);
      statusDiv.innerHTML = `<div class="alert alert-${alertType}">${message}</div>`;
    }

    function getMeasurementName(type) {
      const names = {
        glucose: 'Glukosa',
        bp: 'Tekanan Darah',
        hr: 'Detak Jantung',
        weight: 'Berat & BMI'
      };
      return names[type] || type;
    }

    // ============================================
    // NAVIGATION
    // ============================================
    function showKunjungan() {
      document.getElementById('selection-menu').style.display = 'none';
      document.querySelectorAll('.measurement-card, .kunjungan-card').forEach(card => {
        card.classList.remove('active');
      });
      document.getElementById('card-kunjungan').classList.add('active');
      loadDoctorsForKunjungan(); // ‚úÖ TAMBAH INI
      addLog('Formulir Kunjungan Baru dibuka', 'success');
    }

    function showMeasurement(type) {
      const targetCard = document.getElementById(`card-${type}`);
      if (!targetCard) {
        console.error(`Card dengan ID 'card-${type}' tidak ditemukan`);
        addLog(`Error: Formulir ${type} tidak ditemukan`, 'error');
        return;
      }
      
      document.getElementById('selection-menu').style.display = 'none';
      document.querySelectorAll('.measurement-card, .kunjungan-card').forEach(card => {
        card.classList.remove('active');
      });
      targetCard.classList.add('active');
      loadPatients(type);
      addLog(`Formulir ${getMeasurementName(type)} dibuka`, 'success');
    }

    function backToMenu() {
      document.getElementById('selection-menu').style.display = 'block';
      document.querySelectorAll('.measurement-card, .kunjungan-card').forEach(card => {
        card.classList.remove('active');
      });
      
      // Disconnect all MCU devices
      Object.keys(mcuDevices).forEach(deviceType => {
        if (mcuDevices[deviceType]) {
          stopMCUBLE(deviceType);
        }
      });
      
      addLog('Kembali ke menu pilihan', 'info');
    }

    // ============================================
    // DROPDOWN FUNCTIONS
    // ============================================
    async function loadPatients(type) {
      try {
        const response = await fetch('/api/patients/active');
        const result = await response.json();
        
        if (result.success) {
          const select = document.getElementById(`${type}-emr-pasien`);
          select.innerHTML = '<option value="">-- Pilih Pasien --</option>';
          
          result.patients.forEach(patient => {
            const option = document.createElement('option');
            option.value = patient.emr_no;
            option.textContent = `${patient.nama} (EMR: ${patient.emr_no}) - ${patient.poli}`;
            select.appendChild(option);
          });
          
          addLog(`${result.patients.length} pasien dimuat untuk ${getMeasurementName(type)}`, 'success');
        }
      } catch (err) {
        addLog(`Error loading patients: ${err.message}`, 'error');
      }
    }

    async function loadVisitsByPatient(emr, type) {
      try {
        const response = await fetch(`/api/visits/by-patient/${emr}`);
        const result = await response.json();
        
        const select = document.getElementById(`${type}-id-kunjungan`);
        select.innerHTML = '<option value="">-- Pilih Kunjungan --</option>';
        
        if (result.success && result.visits.length > 0) {
          result.visits.forEach(visit => {
            const option = document.createElement('option');
            option.value = visit.id_kunjungan;
            
            const date = new Date(visit.tanggal_kunjungan);
            const dateStr = date.toLocaleDateString('id-ID');
            const timeStr = date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
            
            const statusBadge = visit.status === 'aktif' ? 'üü¢' : '‚ö´';
            const keluhan = visit.keluhan ? ` - ${visit.keluhan.substring(0, 30)}...` : '';
            
            option.textContent = `${statusBadge} ID ${visit.id_kunjungan} (${dateStr} ${timeStr})${keluhan}`;
            select.appendChild(option);
          });
          
          select.disabled = false;
          addLog(`${result.visits.length} kunjungan ditemukan`, 'success');
        } else {
          select.innerHTML = '<option value="">-- Tidak ada kunjungan --</option>';
          select.disabled = true;
          addLog('Pasien belum memiliki kunjungan', 'error');
        }
      } catch (err) {
        addLog(`Error loading visits: ${err.message}`, 'error');
      }
    }

    async function displayPatientInfo(emr, type) {
      try {
        const response = await fetch(`/api/patients/${emr}/info`);
        const result = await response.json();
        
        if (result.success) {
          const patient = result.patient;
          const infoDiv = document.getElementById(`${type}-patient-info`);
          
          const age = new Date().getFullYear() - new Date(patient.tanggal_lahir).getFullYear();
          const gender = patient.jenis_kelamin === 'L' ? 'Laki-laki' : 'Perempuan';
          
          infoDiv.innerHTML = `
            <div class="patient-info mt-2">
              ‚úì <strong>${patient.nama}</strong><br>
              <small>${gender}, ${age} tahun | Poli: ${patient.poli}</small>
            </div>
          `;
          
          currentPatients[type] = emr;
          addLog(`Info pasien dimuat: ${patient.nama}`, 'success');
        }
      } catch (err) {
        addLog(`Error loading patient info: ${err.message}`, 'error');
      }
    }

    // ============================================
    // PATIENT VALIDATION
    // ============================================
    async function validatePatient(emrPasien, type) {
      try {
        const response = await fetch(`/validasi_pasien/${emrPasien}`);
        const result = await response.json();
        const infoDiv = document.getElementById(`${type}-patient-info`);
        
        if (result.valid) {
          currentPatients[type] = emrPasien;
          infoDiv.innerHTML = `<div class="patient-info mt-2">‚úì <strong>${result.pasien.nama}</strong><br><small>Poli: ${result.pasien.poli} | ${result.pasien.jenis_kelamin === 'L' ? 'Laki-laki' : 'Perempuan'}</small></div>`;
          addLog(`Pasien ditemukan: ${result.pasien.nama} (EMR: ${emrPasien})`, 'success');
          return true;
        } else {
          if (type === 'kunjungan') {
            infoDiv.innerHTML = `
              <div class="alert alert-warning mt-2">
                ‚ö† Pasien dengan EMR ${emrPasien} belum terdaftar.
                <button type="button" class="btn btn-primary btn-sm mt-2" onclick="showFormPasienBaru(${emrPasien})">
                  <i class="fas fa-user-plus"></i> Daftar Pasien Baru
                </button>
              </div>`;
            addLog(`Pasien EMR ${emrPasien} tidak ditemukan - silakan daftar`, 'error');
          } else {
            infoDiv.innerHTML = `<div class="alert alert-danger mt-2">‚úó Pasien dengan EMR ${emrPasien} tidak ditemukan. Daftarkan pasien lewat menu Kunjungan Baru.</div>`;
            addLog(`Pasien EMR ${emrPasien} tidak ditemukan`, 'error');
          }
          return false;
        }
      } catch (err) {
        const infoDiv = document.getElementById(`${type}-patient-info`);
        infoDiv.innerHTML = `<div class="alert alert-danger mt-2">‚úó Error: ${err.message}</div>`;
        addLog('Error validasi: ' + err.message, 'error');
        return false;
      }
    }

    function showFormPasienBaru(emr) {
      document.getElementById('card-kunjungan').classList.remove('active');
      document.getElementById('card-pasien-baru').classList.add('active');
      document.getElementById('pasien-baru-emr').value = emr; 
      addLog(`Form pendaftaran pasien baru dibuka untuk EMR: ${emr}`, 'info');
    }

    // ============================================
    // BLUETOOTH FUNCTIONS
    // ============================================
    function parseSFLOAT(bytes) {
      if (bytes.length < 2) return null;
      const mantissa = bytes[0] | (bytes[1] << 8) | ((bytes[2] & 0x0F) << 16);
      const exponent = ((bytes[2] & 0xF0) >> 4);
      if (exponent === 0xF) return null;
      const exp = exponent > 7 ? exponent - 16 : exponent;
      return mantissa * Math.pow(10, exp);
    }

    // function handleGlucose(event) {
    //   try {
    //     const value = event.target.value;
    //     const bytes = new Uint8Array(value.buffer);
    //     let glucoseValue = null;

    //     if (bytes.length >= 4) {
    //       const glucoseBytes = [bytes[1], bytes[2], bytes[3]];
    //       glucoseValue = parseSFLOAT(glucoseBytes);
    //     }

    //     if (glucoseValue !== null) {
    //       glucoseValue = Math.round(glucoseValue * 10) / 10;
    //       measurementData.glucose = glucoseValue;
    //       document.getElementById('glucose-value').textContent = glucoseValue.toFixed(0);
    //       document.getElementById('btn-save-glucose').disabled = false;
    //       addLog(`Glukosa terukur: ${glucoseValue} mg/dL`, 'success');
    //       showStatus('glucose', `‚úì Glukosa terukur: ${glucoseValue} mg/dL`, 'success');
    //     }
    //   } catch (err) {
    //     addLog(`Error parsing glukosa: ${err.message}`, 'error');
    //   }
    // }

    function handleBP(event) {
      try {
        const value = event.target.value;
        const bytes = new Uint8Array(value.buffer);

        if (bytes.length >= 5) {
          const systolic = parseSFLOAT([bytes[1], bytes[2], 0]);
          const diastolic = parseSFLOAT([bytes[3], bytes[4], 0]);
          const bpValue = `${Math.round(systolic)}/${Math.round(diastolic)}`;
          
          measurementData.bp = bpValue;
          document.getElementById('bp-value').textContent = bpValue;
          document.getElementById('btn-save-bp').disabled = false;
          addLog(`Tensi terukur: ${bpValue} mmHg`, 'success');
          showStatus('bp', `‚úì Tensi terukur: ${bpValue} mmHg`, 'success');
        }
      } catch (err) {
        addLog(`Error parsing tensi: ${err.message}`, 'error');
      }
    }

    function handleHR(event) {
      try {
        const value = event.target.value;
        const bytes = new Uint8Array(value.buffer);
        let hrValue = null;
        const flags = bytes[0];

        if ((flags & 0x01) === 0) {
          hrValue = bytes[1];
        } else {
          hrValue = bytes[1] | (bytes[2] << 8);
        }

        if (hrValue !== null) {
          measurementData.hr = hrValue;
          document.getElementById('hr-value').textContent = hrValue;
          document.getElementById('btn-save-hr').disabled = false;
          addLog(`Heart Rate terukur: ${hrValue} bpm`, 'success');
          showStatus('hr', `‚úì Heart Rate terukur: ${hrValue} bpm`, 'success');
        }
      } catch (err) {
        addLog(`Error parsing heart rate: ${err.message}`, 'error');
      }
    }

    function handleWeight(event) {
      try {
        const value = event.target.value;
        const bytes = new Uint8Array(value.buffer);

        if (bytes.length >= 3) {
          const flags = bytes[0];
          const weightRaw = bytes[1] | (bytes[2] << 8);
          const divisor = (flags & 0x01) ? 100 : 200;
          const weightValue = weightRaw / divisor;
          const displayWeight = Math.round(weightValue * 10) / 10;
          
          measurementData.weight = displayWeight;
          document.getElementById('weight-value').textContent = displayWeight.toFixed(1);
          
          const height = parseFloat(document.getElementById('weight-height').value);
          if (height > 0) {
            calculateBMI(displayWeight, height);
          }
          
          document.getElementById('btn-save-weight').disabled = false;
          addLog(`Berat Badan terukur: ${displayWeight} kg`, 'success');
          showStatus('weight', `‚úì Berat Badan terukur: ${displayWeight} kg`, 'success');
        }
      } catch (err) {
        addLog(`Error parsing weight: ${err.message}`, 'error');
      }
    }

    function calculateBMI(weight, heightCm) {
      const heightM = heightCm / 100;
      const bmi = weight / (heightM * heightM);
      const bmiRounded = Math.round(bmi * 10) / 10;
      
      measurementData.bmi = bmiRounded;
      measurementData.height = heightCm;
      
      document.getElementById('bmi-value').textContent = bmiRounded.toFixed(1);
      
      let category = '';
      if (bmi < 18.5) category = 'Underweight';
      else if (bmi < 25) category = 'Normal';
      else if (bmi < 30) category = 'Overweight';
      else category = 'Obese';
      
      document.getElementById('bmi-category').textContent = category;
      addLog(`BMI dihitung: ${bmiRounded.toFixed(1)} (${category})`, 'success');
    }

    async function scanBLE(type, service, characteristic, handler) {
      const emrPasien = parseInt(document.getElementById(`${type}-emr-pasien`).value);
      const idKunjungan = parseInt(document.getElementById(`${type}-id-kunjungan`).value);
      
      if (!emrPasien || isNaN(emrPasien)) {
        alert('Pilih pasien terlebih dahulu');
        return;
      }

      if (!idKunjungan || isNaN(idKunjungan)) {
        alert('Pilih kunjungan terlebih dahulu');
        return;
      }

      if (!navigator.bluetooth) {
        alert('Browser tidak mendukung Web Bluetooth API!\nGunakan Chrome, Edge, atau Opera.');
        return;
      }

      try {
        showStatus(type, 'üîç Mencari perangkat...', 'info');
        addLog(`Scanning ${getMeasurementName(type)}...`, 'info');
        
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ services: [service] }],
          optionalServices: [service]
        });

        currentDevices[type] = device;
        showStatus(type, `‚úì Terhubung: ${device.name || 'Device'}`, 'success');
        addLog(`Device ditemukan: ${device.name}`, 'success');

        const server = await device.gatt.connect();
        const bleService = await server.getPrimaryService(service);
        const bleChar = await bleService.getCharacteristic(characteristic);
        
        await bleChar.startNotifications();
        bleChar.addEventListener('characteristicvaluechanged', handler);
        
        document.getElementById(`btn-scan-${type}`).disabled = true;
        document.getElementById(`btn-stop-${type}`).disabled = false;
        
        showStatus(type, '‚úì Siap menerima data - lakukan pengukuran', 'success');
        addLog(`${getMeasurementName(type)} siap menerima data`, 'success');

      } catch (err) {
        if (err.name === 'NotFoundError') {
          showStatus(type, '‚úó Perangkat tidak ditemukan', 'danger');
          addLog('User membatalkan atau device tidak ditemukan', 'error');
        } else {
          showStatus(type, `‚úó Error: ${err.message}`, 'danger');
          addLog(`Scan error: ${err.message}`, 'error');
        }
      }
    }

    function stopConnection(type) {
      try {
        if (currentDevices[type]) {
          if (currentDevices[type].gatt && currentDevices[type].gatt.connected) {
            currentDevices[type].gatt.disconnect();
          }
          currentDevices[type] = null;
          document.getElementById(`btn-scan-${type}`).disabled = false;
          document.getElementById(`btn-stop-${type}`).disabled = true;
          addLog(`Koneksi ${getMeasurementName(type)} dihentikan`, 'success');
          showStatus(type, '‚úì Koneksi dihentikan', 'success');
        } else {
          document.getElementById(`btn-scan-${type}`).disabled = false;
          document.getElementById(`btn-stop-${type}`).disabled = true;
          addLog(`${getMeasurementName(type)} sudah tidak terhubung`, 'info');
          showStatus(type, '‚úì Device sudah tidak terhubung', 'info');
        }
      } catch (err) {
        addLog(`Error saat disconnect: ${err.message}`, 'error');
        showStatus(type, `‚úó Error: ${err.message}`, 'danger');
        currentDevices[type] = null;
        document.getElementById(`btn-scan-${type}`).disabled = false;
        document.getElementById(`btn-stop-${type}`).disabled = true;
      }
    }

    // ============================================
    // SERVER COMMUNICATION
    // ============================================
    async function sendToServer(tipe, emrPasien, idKunjungan, dataValue, emrDokter = null) { 
      try {
        const response = await fetch('/simpan_data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id_kunjungan: parseInt(idKunjungan),
            emr_no: parseInt(emrPasien),
            tipe_device: tipe,
            data: dataValue
          })
        });

        const result = await response.json();
        
        if (result.success) {
          addLog(`${tipe} disimpan ke database (ID: ${result.id})`, 'success');
          return true;
        } else {
          addLog(`Error menyimpan: ${result.error}`, 'error');
          return false;
        }
      } catch (err) {
        addLog(`Network error: ${err.message}`, 'error');
        return false;
      }
    }

    function setupDropdowns(type) {
      const patientSelect = document.getElementById(`${type}-emr-pasien`);
      const visitSelect = document.getElementById(`${type}-id-kunjungan`);
      const scanBtn = type === 'glucose' 
        ? null 
        : document.getElementById(`btn-scan-${type}`);
      
      patientSelect.addEventListener('change', async function() {
        const emr = String(this.value);  // ‚úÖ Gunakan STRING
        
        if (emr && !isNaN(emr)) {
          await displayPatientInfo(emr, type);
          await loadVisitsByPatient(emr, type);
          visitSelect.value = '';
          scanBtn.disabled = true;
        } else {
          document.getElementById(`${type}-patient-info`).innerHTML = '';
          visitSelect.innerHTML = '<option value="">-- Pilih pasien terlebih dahulu --</option>';
          visitSelect.disabled = true;
          scanBtn.disabled = true;
          currentPatients[type] = null;
        }
      });
      
      visitSelect.addEventListener('change', function() {
        const idKunjungan = parseInt(this.value);
        
        if (idKunjungan && !isNaN(idKunjungan)) {
          currentVisits[type] = idKunjungan;
          scanBtn.disabled = false;
          addLog(`Kunjungan ID ${idKunjungan} dipilih`, 'success');
        } else {
          currentVisits[type] = null;
          scanBtn.disabled = true;
        }
      });
    }

    async function loadPatientsForFilter() {
      try {
        const response = await fetch('/api/patients/active');
        const result = await response.json();
        
        if (result.success) {
          const select = document.getElementById('kelola-filter-pasien');
          select.innerHTML = '<option value="">-- Semua Pasien --</option>';
          
          result.patients.forEach(patient => {
            const option = document.createElement('option');
            option.value = patient.emr_no;
            option.textContent = `${patient.nama} (EMR: ${patient.emr_no})`;
            select.appendChild(option);
          });
          
          addLog(`${result.patients.length} pasien dimuat untuk filter`, 'success');
        }
      } catch (err) {
        addLog(`Error loading patients for filter: ${err.message}`, 'error');
      }
    }
      async function loadDoctorsForKunjungan() {
        try {
          const response = await fetch('/api/doctors/list');
          const result = await response.json();
          
          if (result.success) {
            const select = document.getElementById('new-emr-dokter');
            select.innerHTML = '<option value="">-- Pilih Dokter --</option>';
            
            result.doctors.forEach(doctor => {
              const option = document.createElement('option');
              option.value = doctor.emr_dokter;
              option.textContent = `${doctor.nama}${doctor.spesialisasi ? ` - ${doctor.spesialisasi}` : ''}`;
              select.appendChild(option);
            });
            
            addLog(`${result.doctors.length} dokter dimuat untuk kunjungan`, 'success');
          }
        } catch (err) {
          addLog(`Error loading doctors: ${err.message}`, 'error');
        }
      }

    // ============================================
    // INITIALIZATION - SINGLE DOMContentLoaded
    // ============================================
// ============================================================
// PERBAIKAN: DOMContentLoaded Handler (HAPUS DUPLIKASI)
// ============================================================

document.addEventListener('DOMContentLoaded', function() {
  console.log('‚úì Page loaded, initializing...');
  
  // ============ 1. SETUP DROPDOWN ============
  ['glucose', 'bp', 'hr', 'weight'].forEach(type => {
    setupDropdowns(type);
  });
  
  // ============ 2. SELECTION CARDS ============
  document.querySelectorAll('.selection-card').forEach(card => {
    card.addEventListener('click', function() {
      const action = this.getAttribute('data-action');
      
      if (action === 'kunjungan') {
        showKunjungan();
      } else if (action === 'kelola-kunjungan') {
        showKelolaKunjungan();
      } else if (action === 'mcu') {
        showMCU();
        setTimeout(() => setMCUTime(), 100);
      } else if (action === 'print-mcu') {
        showPrintMCU();
      } else {
        showMeasurement(action);
      }
    });
  });

  // ============ 3. KELOLA KUNJUNGAN FILTER ============
  const filterSelect = document.getElementById('kelola-filter-pasien');
  if (filterSelect) {
    filterSelect.addEventListener('change', function() {
      const emr = this.value;
      loadKunjunganForKelola(emr || null);
    });
  }

  // ============ 4. BACK BUTTONS ============
  document.querySelectorAll('[data-back-menu]').forEach(btn => {
    btn.addEventListener('click', backToMenu);
  });

  // ============ 5. SCAN BUTTONS ============
  document.getElementById('btn-scan-bp')?.addEventListener('click', () => {
    scanBLE('bp', BLOOD_PRESSURE_SERVICE, BP_MEASUREMENT_CHAR, handleBP);
  });
  
  document.getElementById('btn-scan-hr')?.addEventListener('click', () => {
    scanBLE('hr', HEART_RATE_SERVICE, HR_MEASUREMENT_CHAR, handleHR);
  });
  
  document.getElementById('btn-scan-weight')?.addEventListener('click', () => {
    scanBLE('weight', WEIGHT_SCALE_SERVICE, WEIGHT_MEASUREMENT_CHAR, handleWeight);
  });

  // ============ 6. STOP BUTTONS ============
  ['bp', 'hr', 'weight'].forEach(type => {
    document.getElementById(`btn-stop-${type}`)?.addEventListener('click', () => {
      stopConnection(type);
    });
  });

  // ============ 7. FORM SUBMIT - GLUCOSE ============
  const formGlucose = document.getElementById('form-glucose');
  if (formGlucose) {
    formGlucose.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // ‚úÖ UBAH: Ambil dari input, bukan dari measurementData
      const glucoseInput = document.getElementById('glucose-input');
      const value = parseFloat(glucoseInput.value);
      const emrPasien = currentPatients.glucose;
      const idKunjungan = currentVisits.glucose;

      if (value && emrPasien && idKunjungan) {
        const success = await sendToServer('glukosa', emrPasien, idKunjungan, value.toString());
        if (success) {
          alert('‚úì Data Glukosa berhasil disimpan!');
          setTimeout(() => {
            backToMenu();
            formGlucose.reset(); // Reset form
          }, 500);
        }
      } else {
        alert('‚ùå Data tidak lengkap!');
      }
    });
  }

  // ============ 8. FORM SUBMIT - BP ============
  const formBP = document.getElementById('form-bp');
  if (formBP) {
    formBP.addEventListener('submit', async (e) => {
      e.preventDefault();
      const value = measurementData.bp;
      const emrPasien = currentPatients.bp;
      const idKunjungan = currentVisits.bp;

      if (value && emrPasien && idKunjungan) {
        const success = await sendToServer('tensimeter', emrPasien, idKunjungan, value);
        if (success) {
          alert('‚úì Data Tekanan Darah berhasil disimpan!');
          setTimeout(() => {
            backToMenu();
            document.getElementById('bp-value').textContent = '-';
            document.getElementById('btn-save-bp').disabled = true;
            stopConnection('bp');
          }, 500);
        }
      } else {
        alert('‚ùå Data tidak lengkap!');
      }
    });
  }

  // ============ 9. FORM SUBMIT - HR ============
  const formHR = document.getElementById('form-hr');
  if (formHR) {
    formHR.addEventListener('submit', async (e) => {
      e.preventDefault();
      const value = measurementData.hr;
      const emrPasien = currentPatients.hr;
      const idKunjungan = currentVisits.hr;

      if (value && emrPasien && idKunjungan) {
        const success = await sendToServer('heart_rate', emrPasien, idKunjungan, value.toString());
        if (success) {
          alert('‚úì Data Heart Rate berhasil disimpan!');
          setTimeout(() => {
            backToMenu();
            document.getElementById('hr-value').textContent = '-';
            document.getElementById('btn-save-hr').disabled = true;
            stopConnection('hr');
          }, 500);
        }
      } else {
        alert('‚ùå Data tidak lengkap!');
      }
    });
  }

  // ============ 10. FORM SUBMIT - WEIGHT ============
  const formWeight = document.getElementById('form-weight');
  if (formWeight) {
    formWeight.addEventListener('submit', async (e) => {
      e.preventDefault();
      const weight = measurementData.weight;
      const bmi = measurementData.bmi;
      const height = measurementData.height;
      const emrPasien = currentPatients.weight;
      const idKunjungan = currentVisits.weight;

      if (weight && bmi && height && emrPasien && idKunjungan) {
        const ok1 = await sendToServer('timbangan', emrPasien, idKunjungan, weight.toString());
        const ok2 = await sendToServer('tinggi', emrPasien, idKunjungan, height.toString());
        const ok3 = await sendToServer('bmi', emrPasien, idKunjungan, bmi.toString());

        if (ok1 && ok2 && ok3) {
          alert('‚úì Data Berat, Tinggi, dan BMI berhasil disimpan!');
          setTimeout(() => {
            backToMenu();
            document.getElementById('weight-value').textContent = '-';
            document.getElementById('bmi-value').textContent = '-';
            document.getElementById('btn-save-weight').disabled = true;
            stopConnection('weight');
          }, 500);
        }
      } else {
        alert('‚ùå Data tidak lengkap!');
      }
    });
  }

  // ============ 11. WEIGHT HEIGHT AUTO-CALC ============
  const weightHeightInput = document.getElementById('weight-height');
  if (weightHeightInput) {
    weightHeightInput.addEventListener('input', function() {
      const height = parseFloat(this.value);
      const weight = measurementData.weight;
      if (height > 0 && weight > 0) {
        calculateBMI(weight, height);
      }
    });
  }

  // ============ 12. FORM KUNJUNGAN ============
  const formKunjungan = document.getElementById('form-kunjungan');
  if (formKunjungan) {
    formKunjungan.addEventListener('submit', async (e) => {
      e.preventDefault();
      const emrPasien = document.getElementById('new-emr-pasien').value.trim();
      const keluhan = document.getElementById('new-keluhan').value.trim();
      const emrDokter = document.getElementById('new-emr-dokter').value;
      
      if (!emrPasien) {
        showStatus('kunjungan', '‚úó EMR Pasien harus diisi', 'danger');
        return;
      }
      
      const emrInt = parseInt(emrPasien);
      if (isNaN(emrInt) || emrInt <= 0) {
        showStatus('kunjungan', '‚úó EMR Pasien harus angka positif', 'danger');
        return;
      }
      
      const valid = await validatePatient(emrInt, 'kunjungan');
      if (!valid) {
        showStatus('kunjungan', '‚úó Pasien tidak ditemukan atau belum terdaftar', 'danger');
        return;
      }
      
      try {
        showStatus('kunjungan', '‚è≥ Menyimpan kunjungan...', 'info');
        const response = await fetch('/api/visits', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            emr_no: String(emrPasien),
            keluhan: keluhan || '',
            emr_dokter: emrDokter ? parseInt(emrDokter) : null
          })
        });
        
        const result = await response.json();
        if (result.success) {
          const newIdKunjungan = result.id_kunjungan;
          showStatus('kunjungan', `‚úì Kunjungan berhasil dibuat! ID: ${newIdKunjungan}`, 'success');
          addLog(`‚úì Kunjungan ID ${newIdKunjungan} dibuat untuk EMR ${emrPasien}`, 'success');
          alert(`‚úì Kunjungan berhasil dibuat!\n\nID Kunjungan: ${newIdKunjungan}\nEMR Pasien: ${emrPasien}`);
          formKunjungan.reset();
          document.getElementById('kunjungan-patient-info').innerHTML = '';
          setTimeout(() => backToMenu(), 1000);
        } else {
          showStatus('kunjungan', `‚úó Error: ${result.error}`, 'danger');
          addLog(`‚ùå Error: ${result.error}`, 'error');
        }
      } catch (err) {
        showStatus('kunjungan', `‚úó Network Error: ${err.message}`, 'danger');
      }
    });

    // Auto-validate patient saat blur
    // document.getElementById('new-emr-pasien').addEventListener('blur', async function() {
    //   const emr = this.value.trim();
    //   if (emr) {
    //     if (!/^\d{11}$/.test(emr)) {
    //       document.getElementById('kunjungan-patient-info').innerHTML = 
    //         `<div class="alert alert-danger mt-2">‚úó EMR harus format 11 digit (YYYYMMDDNNN)</div>`;
    //       return;
    //     }
    //     await validatePatient(emr, 'kunjungan');
    //   }
    document.getElementById('new-emr-pasien').addEventListener('blur', async function() {
      const emr = this.value.trim();
      if (emr) {
        // ‚úÖ HAPUS validasi format 11 digit
        await validatePatient(emr, 'kunjungan');
      }
    });
  }

  // ============ 13. FORM PASIEN BARU ============
  const formPasienBaru = document.getElementById('form-pasien-baru');
  const btnCancelPasienBaru = document.getElementById('btn-cancel-pasien-baru');

  if (formPasienBaru) {
    formPasienBaru.addEventListener('submit', async (e) => {
      e.preventDefault();
      const emr = document.getElementById('pasien-baru-emr').value.trim();
      const nama = document.getElementById('pasien-baru-nama').value.trim();
      const tglLahir = document.getElementById('pasien-baru-tgl-lahir').value;
      const jk = document.getElementById('pasien-baru-jk').value;
      const poli = document.getElementById('pasien-baru-poli').value;
      const alamat = document.getElementById('pasien-baru-alamat').value.trim();
      
      if (!emr || !nama || !tglLahir || !jk || !poli) {
        showStatus('pasien-baru', '‚úó Semua field wajib harus diisi', 'danger');
        return;
      }
      
      try {
        showStatus('pasien-baru', '‚è≥ Mendaftarkan pasien...', 'info');
        const response = await fetch('/api/patients/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            emr_no: emr,
            nama: nama,
            tanggal_lahir: tglLahir,
            jenis_kelamin: jk,
            poli: poli,
            alamat: alamat || ''
          })
        });
        
        const result = await response.json();
        if (result.success) {
          const newEmrNo = result.emr_no;
          showStatus('pasien-baru', `‚úì Pasien berhasil didaftarkan! EMR: ${newEmrNo}`, 'success');
          addLog(`‚úì Pasien baru: ${nama} (EMR: ${newEmrNo})`, 'success');
          alert(`‚úì Pasien berhasil didaftarkan!\n\nNama: ${nama}\nEMR: ${newEmrNo}\nPoli: ${poli}`);
          
          formPasienBaru.reset();
          document.getElementById('pasien-baru-status').innerHTML = '';
          document.getElementById('card-pasien-baru').classList.remove('active');
          document.getElementById('card-kunjungan').classList.add('active');
          document.getElementById('new-emr-pasien').value = newEmrNo;
          await validatePatient(newEmrNo, 'kunjungan');
        } else {
          showStatus('pasien-baru', `‚úó Error: ${result.error}`, 'danger');
          addLog(`‚ùå Error: ${result.error}`, 'error');
        }
      } catch (err) {
        showStatus('pasien-baru', `‚úó Error: ${err.message}`, 'danger');
        addLog(`‚ùå Network error: ${err.message}`, 'error');
      }
    });
  }

  if (btnCancelPasienBaru) {
    btnCancelPasienBaru.addEventListener('click', function() {
      document.getElementById('card-pasien-baru').classList.remove('active');
      document.getElementById('card-kunjungan').classList.add('active');
      document.getElementById('form-pasien-baru').reset();
      document.getElementById('pasien-baru-status').innerHTML = '';
      addLog('Batal mendaftar pasien baru', 'info');
    });
  }
  // ============ 14.5. MCU BLUETOOTH SCAN BUTTONS ============
  // ============ MCU BLUETOOTH SCAN BUTTONS ============
  document.getElementById('btn-scan-mcu-hr')?.addEventListener('click', () => {
    scanMCUBLE('hr', HEART_RATE_SERVICE, HR_MEASUREMENT_CHAR, handleMCUHeartRate);
  });

  document.getElementById('btn-scan-mcu-glucose')?.addEventListener('click', () => {
    scanMCUBLE('glucose', GLUCOSE_SERVICE, GLUCOSE_MEASUREMENT_CHAR, handleMCUGlucose);
  });

  document.getElementById('btn-scan-mcu-bp')?.addEventListener('click', () => {
    scanMCUBLE('bp', BLOOD_PRESSURE_SERVICE, BP_MEASUREMENT_CHAR, handleMCUBloodPressure);
  });

  document.getElementById('btn-scan-mcu-weight')?.addEventListener('click', () => {
    scanMCUBLE('weight', WEIGHT_SCALE_SERVICE, WEIGHT_MEASUREMENT_CHAR, handleMCUWeight);
  });

  // ============ 14. BROWSER COMPATIBILITY CHECK ============
  if (!navigator.bluetooth) {
    addLog('‚ö† Browser tidak mendukung Web Bluetooth API', 'error');
    addLog('Gunakan Chrome, Edge, atau Opera', 'error');
  } else {
    addLog('‚úì Browser mendukung Web Bluetooth API', 'success');
  }

  // ============ 15. INITIAL LOGS ============
  addLog('Sistem Darsinurse Gateway siap digunakan', 'success');
  addLog(`Login sebagai: <%= nama_perawat %> (EMR: <%= emr_perawat %>)`, 'success');
  addLog('Fall Detection monitoring aktif', 'success');
  
  console.log('‚úì All event listeners initialized');
});

    async function loadKunjunganForKelola(filterEmr = null) {
      try {
        const tbody = document.getElementById('tbody-kunjungan');
        tbody.innerHTML = '<tr><td colspan="6" class="text-center"><i class="fas fa-spinner fa-spin"></i> Memuat...</td></tr>';
        
        const url = filterEmr 
          ? `/api/visits/by-patient/${filterEmr}` 
          : '/api/visits/all'; // ‚ö†Ô∏è Endpoint ini perlu dibuat (lihat di bawah)
        
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.success && result.visits.length > 0) {
          tbody.innerHTML = '';
          
          result.visits.forEach(visit => {
            const date = new Date(visit.tanggal_kunjungan);
            const dateStr = date.toLocaleDateString('id-ID', {
              year: 'numeric', month: 'short', day: 'numeric'
            });
            const timeStr = date.toLocaleTimeString('id-ID', {
              hour: '2-digit', minute: '2-digit'
            });
            
            const statusBadge = visit.status === 'aktif' 
              ? '<span class="badge bg-success">Aktif</span>' 
              : '<span class="badge bg-secondary">Selesai</span>';
            
            const toggleBtn = visit.status === 'aktif'
              ? `<button class="btn btn-danger btn-sm" onclick="updateStatusKunjungan(${visit.id_kunjungan}, 'selesai')">
                  <i class="fas fa-check"></i> Selesaikan
                </button>`
              : `<button class="btn btn-success btn-sm" onclick="updateStatusKunjungan(${visit.id_kunjungan}, 'aktif')">
                  <i class="fas fa-redo"></i> Aktifkan Kembali
                </button>`;
            
            const row = `
              <tr>
                <td>${visit.id_kunjungan}</td>
                <td>${visit.nama_pasien || 'Unknown'}</td>
                <td>${dateStr}<br><small class="text-muted">${timeStr}</small></td>
                <td><small>${visit.keluhan ? visit.keluhan.substring(0, 40) : '-'}</small></td>
                <td>${statusBadge}</td>
                <td>${toggleBtn}</td>
              </tr>
            `;
            
            tbody.insertAdjacentHTML('beforeend', row);
          });
          
          addLog(`${result.visits.length} kunjungan dimuat`, 'success');
        } else {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Tidak ada data kunjungan</td></tr>';
        }
      } catch (err) {
        const tbody = document.getElementById('tbody-kunjungan');
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error: ' + err.message + '</td></tr>';
        addLog('Error loading kunjungan: ' + err.message, 'error');
      }
    }

    // Update status kunjungan
    async function updateStatusKunjungan(idKunjungan, newStatus) {
      if (!confirm(`Yakin ${newStatus === 'selesai' ? 'menyelesaikan' : 'mengaktifkan kembali'} kunjungan ID ${idKunjungan}?`)) {
        return;
      }
      
      try {
        const response = await fetch(`/api/visits/${idKunjungan}/status`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: newStatus })
        });
        
        const result = await response.json();
        
        if (result.success) {
          addLog(`Kunjungan ID ${idKunjungan} diubah ke ${newStatus}`, 'success');
          alert('‚úì Status kunjungan berhasil diupdate!');
          loadKunjunganForKelola(); // Reload table
        } else {
          alert('Error: ' + result.error);
          addLog('Error update status: ' + result.error, 'error');
        }
      } catch (err) {
        alert('Network error: ' + err.message);
        addLog('Network error: ' + err.message, 'error');
      }
    }

    function showKelolaKunjungan() {
      document.getElementById('selection-menu').style.display = 'none';
      document.querySelectorAll('.measurement-card, .kunjungan-card').forEach(card => {
        card.classList.remove('active');
      });
      document.getElementById('card-kelola-kunjungan').classList.add('active');
      
      // ‚úÖ Load patients untuk filter dropdown
      loadPatientsForFilter();
      
      // ‚úÖ Load all visits
      loadKunjunganForKelola();
      
      addLog('Menu Kelola Kunjungan dibuka', 'success');
    }

    // ============================================
    // MCU HANDLERS
    // ============================================

    // Auto-search pasien saat input EMR
    document.getElementById('mcu-emr-pasien')?.addEventListener('input', async function() {
      const emr = this.value.trim();
      if (emr.length >= 3) {
        await displayPatientInfo(emr, 'mcu');
      }
    });

    // Auto-calculate BMI
    function calculateMCUBMI() {
      const weight = parseFloat(document.getElementById('mcu-weight').value);
      const height = parseFloat(document.getElementById('mcu-height').value);
      
      if (weight > 0 && height > 0) {
        const heightM = height / 100;
        const bmi = (weight / (heightM * heightM)).toFixed(1);
        document.getElementById('mcu-bmi').value = bmi;
      }
    }

    document.getElementById('mcu-weight')?.addEventListener('input', calculateMCUBMI);
    document.getElementById('mcu-height')?.addEventListener('input', calculateMCUBMI);

    // Form MCU Submit
    document.getElementById('form-mcu')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const emr = document.getElementById('mcu-emr-pasien').value.trim();
      
      // Validasi pasien dulu
      const isValid = await validateMCUPatient(emr);
      if (!isValid) {
        alert('‚ùå Pasien tidak valid! Silakan daftar pasien terlebih dahulu.');
        return;
      }
      
      const data = {
        emr_no: emr,
        waktu: document.getElementById('mcu-waktu').value,
        heart_rate: document.getElementById('mcu-heart-rate').value,
        respirasi: document.getElementById('mcu-respirasi').value,
        glukosa: document.getElementById('mcu-glucose').value,
        berat_badan_kg: document.getElementById('mcu-weight').value,
        tinggi_badan_cm: document.getElementById('mcu-height').value,
        bmi: document.getElementById('mcu-bmi').value,
        sistolik: document.getElementById('mcu-sistolik').value,
        diastolik: document.getElementById('mcu-diastolik').value,
        kolesterol: document.getElementById('mcu-cholesterol').value,
        asam_urat: document.getElementById('mcu-asam-urat').value
      };
      
      try {
        showStatus('mcu', '‚è≥ Menyimpan data MCU...', 'info');
        const response = await fetch('/api/mcu/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (result.success) {
          alert('‚úì Data MCU berhasil disimpan!');
          showStatus('mcu', `‚úì Data MCU berhasil disimpan! ID: ${result.id}`, 'success');
          addLog(`MCU saved for EMR ${data.emr_no}`, 'success');
          setTimeout(() => {
            backToMenu();
            document.getElementById('form-mcu').reset();
            document.getElementById('mcu-patient-info').innerHTML = '';
            document.getElementById('mcu-patient-registration').style.display = 'none';
          }, 1500);
        } else {
          showStatus('mcu', `‚úó Error: ${result.error}`, 'danger');
        }
      } catch (err) {
        showStatus('mcu', `‚úó Network Error: ${err.message}`, 'danger');
      }
    });

        // Set waktu default ke sekarang
    function setMCUTime() {
      const now = new Date();
      const datetime = now.toISOString().slice(0, 16);
      document.getElementById('mcu-waktu').value = datetime;
    }
    
    // Show MCU Form
    function showMCU() {
      document.getElementById('selection-menu').style.display = 'none';
      document.querySelectorAll('.measurement-card, .kunjungan-card').forEach(card => {
        card.classList.remove('active');
      });
      document.getElementById('card-mcu').classList.add('active');
      setMCUTime();
      addLog('Form MCU dibuka', 'success');
    }

    // Show Print MCU
    async function showPrintMCU() {
      document.getElementById('selection-menu').style.display = 'none';
      document.querySelectorAll('.measurement-card, .kunjungan-card').forEach(card => {
        card.classList.remove('active');
      });
      document.getElementById('card-print-mcu').classList.add('active');
      
      // Load pasien dengan data MCU
      await loadPatientsWithMCU();
      addLog('Form Print MCU dibuka', 'success');
    }

    async function loadPatientsWithMCU() {
      try {
        const response = await fetch('/api/mcu/patients');
        const result = await response.json();
        
        if (result.success) {
          const select = document.getElementById('print-mcu-emr');
          select.innerHTML = '<option value="">-- Pilih Pasien --</option>';
          
          result.patients.forEach(patient => {
            const option = document.createElement('option');
            option.value = patient.emr_no;
            option.textContent = `${patient.nama} (EMR: ${patient.emr_no})`;
            select.appendChild(option);
          });
        }
      } catch (err) {
        addLog(`Error loading MCU patients: ${err.message}`, 'error');
      }
    }

    // Load MCU data by EMR
    document.getElementById('print-mcu-emr')?.addEventListener('change', async function() {
      const emr = this.value;
      if (!emr) return;
      
      try {
        const response = await fetch(`/api/mcu/by-patient/${emr}`);
        const result = await response.json();
        
        const select = document.getElementById('print-mcu-data');
        select.innerHTML = '<option value="">-- Pilih Data MCU --</option>';
        
        if (result.success && result.data.length > 0) {
          result.data.forEach(mcu => {
            const date = new Date(mcu.waktu);
            const dateStr = date.toLocaleDateString('id-ID');
            const option = document.createElement('option');
            option.value = mcu.id;
            option.textContent = `MCU ${dateStr} - BMI: ${mcu.bmi}`;
            select.appendChild(option);
          });
          select.disabled = false;
        } else {
          select.innerHTML = '<option value="">-- Tidak ada data MCU --</option>';
        }
      } catch (err) {
        addLog(`Error loading MCU data: ${err.message}`, 'error');
      }
    });

    // Print MCU button
    document.getElementById('btn-print-mcu')?.addEventListener('click', function() {
      const mcuId = document.getElementById('print-mcu-data').value;
      if (!mcuId) {
        alert('Pilih data MCU terlebih dahulu!');
        return;
      }
      
      // Open print window
      window.open(`/api/mcu/print/${mcuId}`, '_blank');
      addLog(`Printing MCU ID: ${mcuId}`, 'success');
    });
// ============================================
// MCU PATIENT VALIDATION & REGISTRATION
// ============================================

// Auto-search pasien saat input EMR (update yang sudah ada)
document.getElementById('mcu-emr-pasien')?.addEventListener('blur', async function() {
  const emr = this.value.trim();
  if (!emr) {
    document.getElementById('mcu-patient-info').innerHTML = '';
    document.getElementById('mcu-add-patient-btn').style.display = 'none';
    return;
  }
  
  await validateMCUPatient(emr);
});

// Validate MCU Patient
async function validateMCUPatient(emr) {
  const infoDiv = document.getElementById('mcu-patient-info');
  const addBtnDiv = document.getElementById('mcu-add-patient-btn');
  
  try {
    const response = await fetch(`/api/patients/${emr}/basic-info`);
    const result = await response.json();
    
    if (result.success) {
      const patient = result.patient;
      const gender = patient.jenis_kelamin === 'L' ? 'Laki-laki' : 'Perempuan';
      
      infoDiv.innerHTML = `
        <div class="patient-info">
          ‚úì <strong>${patient.nama}</strong><br>
          <small>${gender}, ${patient.age} tahun</small>
        </div>
      `;
      addBtnDiv.style.display = 'none';
      addLog(`Pasien ditemukan: ${patient.nama} (${patient.age} tahun)`, 'success');
      return true;
    } else {
      // Pasien tidak ditemukan
      infoDiv.innerHTML = `
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle"></i> Pasien dengan EMR <strong>${emr}</strong> belum terdaftar
        </div>
      `;
      addBtnDiv.style.display = 'block';
      addLog(`Pasien EMR ${emr} tidak ditemukan`, 'error');
      return false;
    }
  } catch (err) {
    infoDiv.innerHTML = `
      <div class="alert alert-danger">
        <i class="fas fa-times-circle"></i> Error: ${err.message}
      </div>
    `;
    addBtnDiv.style.display = 'none';
    addLog(`Error validasi MCU: ${err.message}`, 'error');
    return false;
  }
}

// Show MCU Patient Registration Form
function showMCUPatientForm() {
  const emr = document.getElementById('mcu-emr-pasien').value.trim();
  document.getElementById('mcu-new-emr').value = emr;
  document.getElementById('mcu-patient-registration').style.display = 'block';
  document.getElementById('mcu-add-patient-btn').style.display = 'none';
  
  // Scroll to form
  document.getElementById('mcu-patient-registration').scrollIntoView({ 
    behavior: 'smooth', 
    block: 'nearest' 
  });
  
  addLog('Form pendaftaran pasien MCU dibuka', 'info');
}

// Cancel MCU Patient Registration
function cancelMCUPatientForm() {
  document.getElementById('mcu-patient-registration').style.display = 'none';
  document.getElementById('mcu-add-patient-btn').style.display = 'block';
  
  // Clear form
  document.getElementById('mcu-new-nama').value = '';
  document.getElementById('mcu-new-tgl-lahir').value = '';
  document.getElementById('mcu-new-jk').value = '';
  document.getElementById('mcu-new-alamat').value = '';
  document.getElementById('mcu-registration-status').innerHTML = '';
  
  addLog('Batal mendaftar pasien MCU', 'info');
}

  // Register MCU Patient
  async function registerMCUPatient() {
    const emr = document.getElementById('mcu-new-emr').value.trim();
    const nama = document.getElementById('mcu-new-nama').value.trim();
    const tglLahir = document.getElementById('mcu-new-tgl-lahir').value;
    const jk = document.getElementById('mcu-new-jk').value;
    const alamat = document.getElementById('mcu-new-alamat').value.trim();
    const statusDiv = document.getElementById('mcu-registration-status');
    
    if (!nama || !tglLahir || !jk) {
      statusDiv.innerHTML = '<div class="alert alert-danger">‚úó Nama, Tanggal Lahir, dan Jenis Kelamin wajib diisi</div>';
      return;
    }
    
    try {
      statusDiv.innerHTML = '<div class="alert alert-info">‚è≥ Mendaftarkan pasien...</div>';
      
      const response = await fetch('/api/patients/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          emr_no: emr,
          nama: nama,
          tanggal_lahir: tglLahir,
          jenis_kelamin: jk,
          poli: 'MCU', // Default poli untuk MCU
          alamat: alamat || ''
        })
      });
      
      const result = await response.json();
      
      if (result.success) {
        statusDiv.innerHTML = `<div class="alert alert-success">‚úì Pasien berhasil didaftarkan!</div>`;
        addLog(`‚úì Pasien MCU baru: ${nama} (EMR: ${emr})`, 'success');
        
        // Hide registration form and revalidate
        setTimeout(async () => {
          document.getElementById('mcu-patient-registration').style.display = 'none';
          await validateMCUPatient(emr);
        }, 1500);
      } else {
        statusDiv.innerHTML = `<div class="alert alert-danger">‚úó ${result.error}</div>`;
        addLog(`‚ùå Error: ${result.error}`, 'error');
      }
    } catch (err) {
      statusDiv.innerHTML = `<div class="alert alert-danger">‚úó Error: ${err.message}</div>`;
      addLog(`‚ùå Network error: ${err.message}`, 'error');
    }
  }
  // ============================================
// MCU BLUETOOTH HANDLERS
// ============================================

let mcuDevices = {
  hr: null,
  glucose: null,
  bp: null,
  weight: null
};

// MCU Heart Rate Handler
function handleMCUHeartRate(event) {
  try {
    const value = event.target.value;
    const bytes = new Uint8Array(value.buffer);
    let hrValue = null;
    const flags = bytes[0];

    if ((flags & 0x01) === 0) {
      hrValue = bytes[1];
    } else {
      hrValue = bytes[1] | (bytes[2] << 8);
    }

    if (hrValue !== null) {
      document.getElementById('mcu-heart-rate').value = hrValue;
      document.getElementById('mcu-hr-source').style.display = 'block';
      document.getElementById('mcu-hr-status').innerHTML = 
        '<span class="text-success"><i class="fas fa-check-circle"></i> Heart Rate terukur: ' + hrValue + ' bpm</span>';
      addLog(`MCU Heart Rate terukur: ${hrValue} bpm`, 'success');
    }
  } catch (err) {
    addLog(`Error parsing MCU heart rate: ${err.message}`, 'error');
  }
}

// MCU Glucose Handler
function handleMCUGlucose(event) {
  try {
    const value = event.target.value;
    const bytes = new Uint8Array(value.buffer);
    let glucoseValue = null;

    if (bytes.length >= 4) {
      const glucoseBytes = [bytes[1], bytes[2], bytes[3]];
      glucoseValue = parseSFLOAT(glucoseBytes);
    }

    if (glucoseValue !== null) {
      glucoseValue = Math.round(glucoseValue * 10) / 10;
      document.getElementById('mcu-glucose').value = glucoseValue.toFixed(0);
      document.getElementById('mcu-glucose-source').style.display = 'block';
      document.getElementById('mcu-glucose-status').innerHTML = 
        '<span class="text-success"><i class="fas fa-check-circle"></i> Glukosa terukur: ' + glucoseValue.toFixed(0) + ' mg/dL</span>';
      addLog(`MCU Glukosa terukur: ${glucoseValue.toFixed(0)} mg/dL`, 'success');
    }
  } catch (err) {
    addLog(`Error parsing MCU glucose: ${err.message}`, 'error');
  }
}

// MCU Blood Pressure Handler
function handleMCUBloodPressure(event) {
  try {
    const value = event.target.value;
    const bytes = new Uint8Array(value.buffer);

    if (bytes.length >= 5) {
      const systolic = parseSFLOAT([bytes[1], bytes[2], 0]);
      const diastolic = parseSFLOAT([bytes[3], bytes[4], 0]);
      
      document.getElementById('mcu-sistolik').value = Math.round(systolic);
      document.getElementById('mcu-diastolik').value = Math.round(diastolic);
      document.getElementById('mcu-bp-source').style.display = 'block';
      document.getElementById('mcu-bp-status').innerHTML = 
        '<span class="text-success"><i class="fas fa-check-circle"></i> Tekanan Darah terukur: ' + 
        Math.round(systolic) + '/' + Math.round(diastolic) + ' mmHg</span>';
      addLog(`MCU Blood Pressure terukur: ${Math.round(systolic)}/${Math.round(diastolic)} mmHg`, 'success');
    }
  } catch (err) {
    addLog(`Error parsing MCU blood pressure: ${err.message}`, 'error');
  }
}

// MCU Weight Handler
function handleMCUWeight(event) {
  try {
    const value = event.target.value;
    const bytes = new Uint8Array(value.buffer);

    if (bytes.length >= 3) {
      const flags = bytes[0];
      const weightRaw = bytes[1] | (bytes[2] << 8);
      const divisor = (flags & 0x01) ? 100 : 200;
      const weightValue = weightRaw / divisor;
      const displayWeight = Math.round(weightValue * 10) / 10;
      
      document.getElementById('mcu-weight').value = displayWeight.toFixed(1);
      document.getElementById('mcu-weight-source').style.display = 'block';
      document.getElementById('mcu-weight-status').innerHTML = 
        '<span class="text-success"><i class="fas fa-check-circle"></i> Berat Badan terukur: ' + 
        displayWeight.toFixed(1) + ' kg</span>';
      
      // Auto calculate BMI if height is filled
      calculateMCUBMI();
      
      addLog(`MCU Berat Badan terukur: ${displayWeight.toFixed(1)} kg`, 'success');
    }
  } catch (err) {
    addLog(`Error parsing MCU weight: ${err.message}`, 'error');
  }
}

// Generic MCU BLE Scanner
async function scanMCUBLE(deviceType, service, characteristic, handler) {
  if (!navigator.bluetooth) {
    alert('Browser tidak mendukung Web Bluetooth API!\nGunakan Chrome, Edge, atau Opera.');
    addLog('Browser tidak support Bluetooth', 'error');
    return;
  }

  const statusId = `mcu-${deviceType}-status`;
  const btnId = `btn-scan-mcu-${deviceType}`;
  
  try {
    document.getElementById(statusId).innerHTML = 
      '<span class="text-info"><i class="fas fa-spinner fa-spin"></i> Mencari perangkat...</span>';
    document.getElementById(btnId).disabled = true;
    
    addLog(`Scanning MCU ${deviceType}...`, 'info');
    
    const device = await navigator.bluetooth.requestDevice({
      filters: [{ services: [service] }],
      optionalServices: [service]
    });

    mcuDevices[deviceType] = device;
    
    document.getElementById(statusId).innerHTML = 
      '<span class="text-success"><i class="fas fa-check-circle"></i> Terhubung: ' + 
      (device.name || 'Device') + '</span>';
    addLog(`MCU ${deviceType} device ditemukan: ${device.name}`, 'success');

    const server = await device.gatt.connect();
    const bleService = await server.getPrimaryService(service);
    const bleChar = await bleService.getCharacteristic(characteristic);
    
    await bleChar.startNotifications();
    bleChar.addEventListener('characteristicvaluechanged', handler);
    
    document.getElementById(statusId).innerHTML = 
      '<span class="text-success"><i class="fas fa-check-circle"></i> Siap menerima data - lakukan pengukuran</span>';
    addLog(`MCU ${deviceType} siap menerima data`, 'success');

    // Handle disconnect
    device.addEventListener('gattserverdisconnected', () => {
      document.getElementById(statusId).innerHTML = 
        '<span class="text-warning"><i class="fas fa-exclamation-triangle"></i> Device terputus</span>';
      document.getElementById(btnId).disabled = false;
      addLog(`MCU ${deviceType} terputus`, 'error');
      mcuDevices[deviceType] = null;
    });

  } catch (err) {
    document.getElementById(btnId).disabled = false;
    
    if (err.name === 'NotFoundError') {
      document.getElementById(statusId).innerHTML = 
        '<span class="text-danger"><i class="fas fa-times-circle"></i> Device tidak ditemukan atau dibatalkan</span>';
      addLog(`MCU ${deviceType}: User membatalkan atau device tidak ditemukan`, 'error');
    } else {
      document.getElementById(statusId).innerHTML = 
        '<span class="text-danger"><i class="fas fa-times-circle"></i> Error: ' + err.message + '</span>';
      addLog(`MCU ${deviceType} scan error: ${err.message}`, 'error');
    }
  }
}

// Stop MCU BLE Connection
function stopMCUBLE(deviceType) {
  try {
    if (mcuDevices[deviceType]) {
      if (mcuDevices[deviceType].gatt && mcuDevices[deviceType].gatt.connected) {
        mcuDevices[deviceType].gatt.disconnect();
      }
      mcuDevices[deviceType] = null;
      
      const statusId = `mcu-${deviceType}-status`;
      document.getElementById(statusId).innerHTML = 
        '<span class="text-success"><i class="fas fa-check-circle"></i> Koneksi dihentikan</span>';
      
      addLog(`MCU ${deviceType} koneksi dihentikan`, 'success');
    }
  } catch (err) {
    addLog(`Error disconnect MCU ${deviceType}: ${err.message}`, 'error');
  }
}
  </script>
</body>
</html>